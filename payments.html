<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment Processing | CustomPC.tech Admin</title>
  <meta name="description" content="Admin payment processing interface for CustomPC.tech - Secure Square payment integration for customer transactions." />
  <meta name="keywords" content="payment processing, admin, square payments, custompc.tech" />
  <meta name="author" content="CustomPC.tech" />
  <meta name="robots" content="noindex, nofollow" />
  
  <!-- Security headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://sandbox.web.squarecdn.com https://web.squarecdn.com; script-src 'self' 'unsafe-inline' https://sandbox.web.squarecdn.com https://web.squarecdn.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://connect.squareupsandbox.com https://connect.squareup.com;" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="images/logo.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="images/logo.png" />
  <link rel="shortcut icon" href="images/logo.png" />
  <link rel="apple-touch-icon" href="images/logo.png" />
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="payment-styles.css">
  
  <style>
    /* Enhanced validation styles */
    .form-input.invalid {
      border-color: #ff4444 !important;
      box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.2) !important;
    }
    
    .form-input.valid {
      border-color: #4caf50 !important;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2) !important;
    }
    
    .field-error {
      color: #ff4444;
      font-size: 0.875rem;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .field-error::before {
      content: "⚠️";
      font-size: 0.75rem;
    }
    
    .field-suggestion {
      margin-top: 4px;
    }
    
    .suggestion-btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .suggestion-btn:hover {
      background: #1976d2;
    }
    
    .network-status {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ff9800;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 9999;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .network-status.offline {
      background: #f44336;
    }
    
    .status-icon {
      font-size: 1.2em;
    }
    
    /* Payment message enhancements */
    .payment-message {
      padding: 12px 16px;
      border-radius: 6px;
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideInMessage 0.3s ease-out;
    }
    
    .payment-message-error {
      background: #ffebee;
      border: 1px solid #ffcdd2;
      color: #c62828;
    }
    
    .payment-message-success {
      background: #e8f5e8;
      border: 1px solid #c8e6c9;
      color: #2e7d32;
    }
    
    .payment-message-warning {
      background: #fff3e0;
      border: 1px solid #ffcc02;
      color: #ef6c00;
    }
    
    .payment-message-info {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #1565c0;
    }
    
    @keyframes slideInMessage {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Loading states */
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .processing-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #f5f5f5;
      border-radius: 6px;
      margin: 16px 0;
    }
    
    .processing-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #ddd;
      border-top: 2px solid #2196f3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Help button styling */
    .help-btn {
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-right: 8px;
      transition: all 0.2s ease;
    }
    
    .help-btn:hover {
      background: #1976d2;
      transform: scale(1.1);
    }
    
    /* Help panel styling */
    .help-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .help-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      color: #333;
    }
    
    .help-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 16px;
    }
    
    .help-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    
    .help-section {
      margin-bottom: 20px;
    }
    
    .help-section h3 {
      color: #2196f3;
      margin-bottom: 8px;
    }
    
    .shortcut-list {
      list-style: none;
      padding: 0;
    }
    
    .shortcut-list li {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .shortcut-key {
      background: #f5f5f5;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-ready {
      background: #4caf50;
    }
    
    .status-warning {
      background: #ff9800;
    }
    
    .status-error {
      background: #f44336;
    }
  </style>
  
  <!-- Preload Square SDK for better performance -->
  <link rel="preload" href="https://sandbox.web.squarecdn.com/v1/square.js" as="script" />
</head>
<body class="payment-page">
  <!-- Admin Access Control Check -->
  <div id="access-denied" class="access-denied hidden" role="alert" aria-live="assertive">
    <div class="access-denied-content">
      <h1>Access Denied</h1>
      <p>You must be logged in as an administrator to access this page.</p>
      <a href="login.html?admin=true" class="btn-primary">Login as Admin</a>
    </div>
  </div>

  <!-- Main Payment Interface (hidden until admin access verified) -->
  <div id="payment-interface" class="payment-interface hidden">
    <!-- Header Navigation -->
    <header class="payment-header">
      <div class="header-content">
        <div class="brand">
          <a href="index.html" class="brand-link">
            <img src="images/logo.png" alt="CustomPC.tech logo" class="logo" />
            <span class="brand-text">CustomPC.tech</span>
          </a>
        </div>
        
        <nav class="admin-nav" role="navigation" aria-label="Admin navigation">
          <a href="index.html" class="nav-pill">Home</a>
          <a href="builds.html" class="nav-pill">Builds</a>
          <a href="payments.html" class="nav-pill active" aria-current="page">Payments</a>
          <div class="admin-info">
            <span id="admin-username" class="admin-username"></span>
            <button id="help-btn" class="help-btn" type="button" aria-label="Show help and shortcuts" title="Help & Shortcuts">?</button>
            <button id="logout-btn" class="logout-btn" type="button" aria-label="Logout from admin session">Logout</button>
          </div>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="payment-main">
      <div class="payment-container">
        <!-- Page Title -->
        <div class="page-header">
          <h1>Payment Processing</h1>
          <p class="page-subtitle">Secure payment collection powered by Square</p>
        </div>

        <!-- Payment Processing Section -->
        <section class="payment-section" aria-labelledby="payment-heading">
          <div class="section-grid">
            <!-- Payment Form -->
            <div class="payment-form-container">
              <div class="card">
                <div class="card-header">
                  <h2 id="payment-heading">Process Payment</h2>
                  <p class="card-subtitle">Enter payment details and customer information</p>
                </div>
                
                <form id="payment-form" class="payment-form" novalidate aria-describedby="payment-instructions">
                  <div id="payment-instructions" class="sr-only">
                    Complete the payment form with customer information and payment amount to process a secure transaction.
                  </div>

                  <!-- Customer Information -->
                  <fieldset class="form-fieldset">
                    <legend class="fieldset-legend">Customer Information</legend>
                    
                    <div class="form-row">
                      <div class="form-group">
                        <label for="customer-name" class="form-label">Customer Name *</label>
                        <input 
                          id="customer-name" 
                          type="text" 
                          class="form-input" 
                          required 
                          aria-describedby="customer-name-help"
                          autocomplete="name"
                          placeholder="Enter customer's full name"
                        />
                        <div id="customer-name-help" class="form-help">Required for payment processing</div>
                      </div>
                      
                      <div class="form-group">
                        <label for="customer-email" class="form-label">Customer Email *</label>
                        <input 
                          id="customer-email" 
                          type="email" 
                          class="form-input" 
                          required 
                          aria-describedby="customer-email-help"
                          autocomplete="email"
                          placeholder="customer@example.com"
                        />
                        <div id="customer-email-help" class="form-help">Receipt will be sent to this email</div>
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="customer-phone" class="form-label">Phone Number</label>
                      <input 
                        id="customer-phone" 
                        type="tel" 
                        class="form-input" 
                        aria-describedby="customer-phone-help"
                        autocomplete="tel"
                        placeholder="(555) 123-4567"
                      />
                      <div id="customer-phone-help" class="form-help">Optional - for order updates</div>
                    </div>
                  </fieldset>

                  <!-- Payment Amount -->
                  <fieldset class="form-fieldset">
                    <legend class="fieldset-legend">Payment Details</legend>
                    
                    <div class="form-row">
                      <div class="form-group">
                        <label for="payment-amount" class="form-label">Payment Amount *</label>
                        <div class="amount-input-wrapper">
                          <span class="currency-symbol" aria-hidden="true">$</span>
                          <input 
                            id="payment-amount" 
                            type="number" 
                            class="form-input amount-input" 
                            required 
                            min="1" 
                            step="0.01" 
                            aria-describedby="payment-amount-help"
                            placeholder="0.00"
                          />
                        </div>
                        <div id="payment-amount-help" class="form-help">Enter amount in USD (minimum $1.00)</div>
                      </div>
                      
                      <div class="form-group">
                        <label for="payment-description" class="form-label">Description</label>
                        <input 
                          id="payment-description" 
                          type="text" 
                          class="form-input" 
                          aria-describedby="payment-description-help"
                          placeholder="Custom PC Build - Gaming Setup"
                        />
                        <div id="payment-description-help" class="form-help">Optional - what is this payment for?</div>
                      </div>
                    </div>
                  </fieldset>

                  <!-- Square Payment Form -->
                  <fieldset class="form-fieldset">
                    <legend class="fieldset-legend">Payment Method</legend>
                    
                    <div class="payment-method-container">
                      <div id="card-container" class="card-input-container" role="group" aria-labelledby="card-heading">
                        <h3 id="card-heading" class="sr-only">Credit Card Information</h3>
                        <!-- Square Web Payments SDK will inject card form here -->
                        <div class="loading-placeholder">
                          <div class="loading-spinner" aria-hidden="true"></div>
                          <p>Loading secure payment form...</p>
                        </div>
                      </div>
                      
                      <div class="save-card-option">
                        <label class="checkbox-label">
                          <input 
                            id="save-card" 
                            type="checkbox" 
                            class="checkbox-input"
                            aria-describedby="save-card-help"
                          />
                          <span class="checkbox-custom" aria-hidden="true"></span>
                          <span class="checkbox-text">Save card for future payments</span>
                        </label>
                        <div id="save-card-help" class="form-help">Card will be securely stored with Square</div>
                      </div>
                    </div>
                  </fieldset>

                  <!-- Form Actions -->
                  <div class="form-actions">
                    <button 
                      id="payment-submit-btn" 
                      type="submit" 
                      class="btn-primary btn-large"
                      disabled
                      aria-describedby="process-payment-help"
                    >
                      <span class="btn-text">Process Payment</span>
                      <span class="btn-spinner hidden" aria-hidden="true"></span>
                    </button>
                    <div id="process-payment-help" class="form-help">Payment will be processed securely through Square</div>
                    
                    <button 
                      id="clear-form-btn" 
                      type="button" 
                      class="btn-secondary"
                      aria-label="Clear all form fields"
                    >
                      Clear Form
                    </button>
                  </div>

                  <!-- Processing Indicator -->
                  <div id="processing-indicator" class="processing-indicator hidden" role="status" aria-live="polite">
                    <div class="processing-content">
                      <div class="processing-spinner" aria-hidden="true"></div>
                      <span>Processing payment...</span>
                    </div>
                  </div>

                  <!-- Payment Status Messages -->
                  <div id="payment-messages" class="payment-messages" role="status" aria-live="polite">
                    <!-- Success/error messages will be inserted here -->
                  </div>
                </form>
              </div>
            </div>

            <!-- Customer Management Sidebar -->
            <div class="customer-sidebar">
              <div class="card">
                <div class="card-header">
                  <h2>Customer Management</h2>
                  <p class="card-subtitle">Saved customers and payment methods</p>
                </div>
                
                <div class="customer-search">
                  <label for="customer-search-input" class="sr-only">Search customers</label>
                  <div class="search-input-wrapper">
                    <input 
                      id="customer-search-input" 
                      type="search" 
                      class="form-input" 
                      placeholder="Search customers..."
                      aria-describedby="customer-search-help"
                    />
                    <button type="button" id="clear-search-btn" class="clear-search-btn hidden" aria-label="Clear search">×</button>
                  </div>
                  <div class="search-filters">
                    <select id="customer-filter" class="form-input filter-select">
                      <option value="all">All Customers</option>
                      <option value="with-cards">With Saved Cards</option>
                      <option value="without-cards">Without Saved Cards</option>
                      <option value="recent">Recent Activity</option>
                    </select>
                    <select id="customer-sort" class="form-input filter-select">
                      <option value="activity">Sort by Activity</option>
                      <option value="name">Sort by Name</option>
                      <option value="email">Sort by Email</option>
                      <option value="created">Sort by Created Date</option>
                    </select>
                  </div>
                  <div id="customer-search-help" class="form-help">Search by name, email, phone, or card number</div>
                </div>

                <div id="customer-list" class="customer-list">
                  <div class="empty-state">
                    <p>No saved customers yet</p>
                    <p class="empty-state-subtitle">Customers will appear here after their first payment with saved card option</p>
                  </div>
                </div>

                <!-- Saved Payment Methods Section -->
                <div id="saved-payment-methods" class="saved-payment-methods hidden">
                  <div class="section-header">
                    <h3>Saved Payment Methods</h3>
                    <button id="use-new-card-btn" type="button" class="btn-link">Use New Card</button>
                  </div>
                  <div id="saved-cards-list" class="saved-cards-list">
                    <!-- Saved cards will be populated here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Recent Transactions Section -->
        <section class="transactions-section" aria-labelledby="transactions-heading">
          <div class="card">
            <div class="card-header">
              <h2 id="transactions-heading">Recent Transactions</h2>
              <p class="card-subtitle">Latest payment activity</p>
            </div>
            
            <div class="transactions-container">
              <div id="transactions-list" class="transactions-list">
                <div class="empty-state">
                  <p>No transactions yet</p>
                  <p class="empty-state-subtitle">Completed payments will appear here</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script src="shared-auth.js"></script>
  <script src="admin-auth.js"></script>
  
  <!-- Square Web Payments SDK -->
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
  <script src="square-payments.js"></script>
  
  <script>
    // Admin access control and page initialization
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize admin authentication
      const adminAuth = new AdminAuth();
      
      // Check admin access
      if (!adminAuth.isCurrentUserAdmin() || !adminAuth.isAdminSessionValid()) {
        // Show access denied screen
        document.getElementById('access-denied').classList.remove('hidden');
        document.getElementById('payment-interface').classList.add('hidden');
        return;
      }
      
      // Show payment interface
      document.getElementById('access-denied').classList.add('hidden');
      document.getElementById('payment-interface').classList.remove('hidden');
      
      // Update admin info in header
      const adminSession = adminAuth.getAdminSession();
      if (adminSession) {
        document.getElementById('admin-username').textContent = adminSession.username;
      }
      
      // Setup logout handler
      document.getElementById('logout-btn').addEventListener('click', function() {
        adminAuth.logoutAdmin();
      });
      
      // Setup help handler
      document.getElementById('help-btn').addEventListener('click', function() {
        showHelpPanel();
      });
      
      // Initialize payment form handlers
      initializePaymentHandlers();
    });

    // Initialize payment form event handlers
    function initializePaymentHandlers() {
      // Payment form submission
      const paymentForm = document.getElementById('payment-form');
      if (paymentForm) {
        paymentForm.addEventListener('submit', handlePaymentSubmit);
      }

      // Clear form handler with enhanced feedback
      const clearFormBtn = document.getElementById('clear-form-btn');
      if (clearFormBtn) {
        clearFormBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to clear all form fields? This will reset customer information, payment amount, and selected payment methods.')) {
            showPaymentMessage('🧹 Clearing form data...', 'info');
            
            if (window.squarePayments) {
              window.squarePayments.resetForm();
            } else {
              paymentForm.reset();
              document.getElementById('payment-messages').innerHTML = '';
            }
            
            // Clear customer selection
            clearSelectedCustomer();
            
            // Clear all validation states
            const inputs = document.querySelectorAll('#payment-form input');
            inputs.forEach(input => {
              input.classList.remove('valid', 'invalid');
              const formGroup = input.closest('.form-group');
              if (formGroup) {
                const feedback = formGroup.querySelectorAll('.field-error, .field-success, .field-suggestion');
                feedback.forEach(el => el.remove());
              }
            });
            
            setTimeout(() => {
              showPaymentMessage('✅ Form cleared successfully. Ready for new payment.', 'success');
            }, 500);
          }
        });
      }

      // Enable process payment button when Square SDK is ready with enhanced feedback
      const processBtn = document.getElementById('payment-submit-btn');
      if (processBtn) {
        showPaymentMessage('⏳ Initializing secure payment system...', 'info');
        
        // Check if Square SDK is loaded and enable button
        const checkSquareReady = setInterval(() => {
          if (window.squarePayments && window.squarePayments.isInitialized) {
            processBtn.disabled = false;
            clearInterval(checkSquareReady);
            
            // Remove loading placeholder
            const placeholder = document.querySelector('.loading-placeholder');
            if (placeholder) {
              placeholder.remove();
            }
            
            // Show success message
            showPaymentMessage('✅ Payment system ready! Secure payment processing powered by Square is now available.', 'success');
            
            // Auto-clear the success message after 5 seconds
            setTimeout(() => {
              const messages = document.querySelectorAll('.payment-message-success');
              messages.forEach(msg => {
                if (msg.textContent.includes('Payment system ready')) {
                  msg.remove();
                }
              });
            }, 5000);
          }
        }, 100);

        // Timeout after 10 seconds with enhanced error feedback
        setTimeout(() => {
          clearInterval(checkSquareReady);
          if (processBtn.disabled) {
            showPaymentMessage('❌ Payment system failed to initialize. This may be due to network issues or browser compatibility. Please refresh the page and try again.', 'error');
            
            // Provide troubleshooting suggestions
            setTimeout(() => {
              showPaymentMessage('💡 Troubleshooting: Ensure JavaScript is enabled, disable ad blockers, or try a different browser.', 'info');
            }, 2000);
          }
        }, 10000);
      }

      // Save card functionality
      const saveCardCheckbox = document.getElementById('save-card');
      if (saveCardCheckbox) {
        saveCardCheckbox.addEventListener('change', function() {
          // This will be used in the payment processing logic
          console.log('Save card option:', this.checked);
        });
      }

      // Customer search functionality
      const customerSearchInput = document.getElementById('customer-search-input');
      const clearSearchBtn = document.getElementById('clear-search-btn');
      const customerFilter = document.getElementById('customer-filter');
      const customerSort = document.getElementById('customer-sort');
      
      if (customerSearchInput) {
        customerSearchInput.addEventListener('input', function() {
          const query = this.value;
          
          // Show/hide clear button
          if (clearSearchBtn) {
            clearSearchBtn.classList.toggle('hidden', !query);
          }
          
          performCustomerSearch();
        });
      }
      
      if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
          customerSearchInput.value = '';
          this.classList.add('hidden');
          performCustomerSearch();
          customerSearchInput.focus();
        });
      }
      
      if (customerFilter) {
        customerFilter.addEventListener('change', performCustomerSearch);
      }
      
      if (customerSort) {
        customerSort.addEventListener('change', performCustomerSearch);
      }

      // Use new card button
      const useNewCardBtn = document.getElementById('use-new-card-btn');
      if (useNewCardBtn) {
        useNewCardBtn.addEventListener('click', function() {
          clearSelectedCustomer();
          showNewCardForm();
        });
      }

      // Load existing customers on page load
      loadAndDisplayCustomers();

      // Initialize error recovery system
      initializeErrorRecovery();

      // Real-time amount validation
      const amountInput = document.getElementById('payment-amount');
      if (amountInput) {
        amountInput.addEventListener('input', validatePaymentAmount);
        amountInput.addEventListener('blur', validatePaymentAmount);
      }

      // Real-time email validation
      const emailInput = document.getElementById('customer-email');
      if (emailInput) {
        emailInput.addEventListener('input', validateCustomerEmail);
        emailInput.addEventListener('blur', validateCustomerEmail);
      }

      // Real-time name validation
      const nameInput = document.getElementById('customer-name');
      if (nameInput) {
        nameInput.addEventListener('input', validateCustomerName);
        nameInput.addEventListener('blur', validateCustomerName);
      }

      // Real-time phone validation
      const phoneInput = document.getElementById('customer-phone');
      if (phoneInput) {
        phoneInput.addEventListener('input', validateCustomerPhone);
        phoneInput.addEventListener('blur', validateCustomerPhone);
      }

      // Add network error detection
      window.addEventListener('online', handleNetworkStatusChange);
      window.addEventListener('offline', handleNetworkStatusChange);
      
      // Check initial network status
      handleNetworkStatusChange();
    }

    // Show payment error message
    function showPaymentError(message) {
      const messagesContainer = document.getElementById('payment-messages');
      if (messagesContainer) {
        messagesContainer.innerHTML = `
          <div class="payment-message payment-message-error" role="alert">
            <strong>Error:</strong> ${message}
          </div>
        `;
      }
    }

    // Enhanced real-time validation functions
    function validatePaymentAmount() {
      const amountInput = document.getElementById('payment-amount');
      const amount = amountInput.value.trim();
      
      let errorMessage = '';
      let isValid = true;
      let successMessage = '';
      
      if (!amount) {
        errorMessage = 'Payment amount is required';
        isValid = false;
      } else {
        const numericAmount = parseFloat(amount);
        
        if (isNaN(numericAmount)) {
          errorMessage = 'Please enter a valid number';
          isValid = false;
        } else if (numericAmount <= 0) {
          errorMessage = 'Amount must be greater than $0.00';
          isValid = false;
        } else if (numericAmount < 1.00) {
          errorMessage = 'Minimum payment amount is $1.00';
          isValid = false;
        } else if (numericAmount > 999999.99) {
          errorMessage = 'Maximum payment amount is $999,999.99';
          isValid = false;
        } else {
          // Check decimal places
          const decimalPlaces = (amount.split('.')[1] || '').length;
          if (decimalPlaces > 2) {
            errorMessage = 'Amount cannot have more than 2 decimal places';
            isValid = false;
          } else {
            // Valid amount - provide positive feedback
            successMessage = `Valid amount: $${numericAmount.toFixed(2)}`;
            
            // Additional feedback for large amounts
            if (numericAmount >= 1000) {
              successMessage += ' (Large payment - please verify amount)';
            }
          }
        }
      }
      
      updateFieldValidation(amountInput, isValid, errorMessage, successMessage);
      updateSubmitButtonState();
      return isValid;
    }

    function validateCustomerEmail() {
      const emailInput = document.getElementById('customer-email');
      const email = emailInput.value.trim();
      
      let errorMessage = '';
      let isValid = true;
      
      if (!email) {
        errorMessage = 'Email address is required';
        isValid = false;
      } else if (email.length > 254) {
        errorMessage = 'Email address is too long';
        isValid = false;
      } else {
        const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
        
        if (!emailRegex.test(email)) {
          errorMessage = 'Please enter a valid email address';
          isValid = false;
        } else {
          // Check for common typos
          const domain = email.split('@')[1]?.toLowerCase();
          const typoSuggestions = {
            'gmial.com': 'gmail.com',
            'gmai.com': 'gmail.com',
            'yahooo.com': 'yahoo.com',
            'hotmial.com': 'hotmail.com',
            'outlok.com': 'outlook.com'
          };
          
          if (domain && typoSuggestions[domain]) {
            errorMessage = `Did you mean ${email.replace(domain, typoSuggestions[domain])}?`;
            isValid = false;
          }
        }
      }
      
      updateFieldValidation(emailInput, isValid, errorMessage);
      updateSubmitButtonState();
      return isValid;
    }

    function validateCustomerName() {
      const nameInput = document.getElementById('customer-name');
      const name = nameInput.value.trim();
      
      let errorMessage = '';
      let isValid = true;
      
      if (!name) {
        errorMessage = 'Customer name is required';
        isValid = false;
      } else if (name.length < 2) {
        errorMessage = 'Name must be at least 2 characters long';
        isValid = false;
      } else if (name.length > 100) {
        errorMessage = 'Name cannot exceed 100 characters';
        isValid = false;
      } else {
        // Check for valid characters
        const namePattern = /^[a-zA-Z\s\-'\.]+$/;
        if (!namePattern.test(name)) {
          errorMessage = 'Name can only contain letters, spaces, hyphens, and apostrophes';
          isValid = false;
        } else if (!/[a-zA-Z]/.test(name)) {
          errorMessage = 'Name must contain at least one letter';
          isValid = false;
        }
      }
      
      updateFieldValidation(nameInput, isValid, errorMessage);
      updateSubmitButtonState();
      return isValid;
    }

    function validateCustomerPhone() {
      const phoneInput = document.getElementById('customer-phone');
      const phone = phoneInput.value.trim();
      
      let errorMessage = '';
      let isValid = true;
      
      // Phone is optional, so empty is valid
      if (phone) {
        const cleanPhone = phone.replace(/[\s\-\(\)\+\.]/g, '');
        
        if (!/^\d+$/.test(cleanPhone)) {
          errorMessage = 'Phone can only contain digits, spaces, hyphens, parentheses, and plus sign';
          isValid = false;
        } else if (cleanPhone.length < 7) {
          errorMessage = 'Phone number is too short (minimum 7 digits)';
          isValid = false;
        } else if (cleanPhone.length > 15) {
          errorMessage = 'Phone number is too long (maximum 15 digits)';
          isValid = false;
        } else if (cleanPhone.length === 10) {
          // US number validation
          const areaCode = cleanPhone.substring(0, 3);
          if (areaCode.startsWith('0') || areaCode.startsWith('1')) {
            errorMessage = 'Invalid area code (cannot start with 0 or 1)';
            isValid = false;
          }
        }
      }
      
      updateFieldValidation(phoneInput, isValid, errorMessage);
      return isValid;
    }

    function updateFieldValidation(input, isValid, errorMessage, successMessage = '') {
      try {
        const formGroup = input.closest('.form-group');
        if (!formGroup) return;
        
        const existingError = formGroup.querySelector('.field-error');
        const existingSuggestion = formGroup.querySelector('.field-suggestion');
        const existingSuccess = formGroup.querySelector('.field-success');
        
        // Remove existing feedback elements
        if (existingError) existingError.remove();
        if (existingSuggestion) existingSuggestion.remove();
        if (existingSuccess) existingSuccess.remove();
        
        // Update input styling with accessibility
        input.classList.toggle('invalid', !isValid && input.value.length > 0);
        input.classList.toggle('valid', isValid && input.value.length > 0);
        
        // Update ARIA attributes
        if (!isValid && input.value.length > 0) {
          input.setAttribute('aria-invalid', 'true');
          input.setAttribute('aria-describedby', input.id + '-error');
        } else {
          input.removeAttribute('aria-invalid');
          input.removeAttribute('aria-describedby');
        }
        
        // Add error message if invalid and has content
        if (!isValid && input.value.length > 0 && errorMessage) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'field-error';
          errorDiv.id = input.id + '-error';
          errorDiv.setAttribute('role', 'alert');
          errorDiv.setAttribute('aria-live', 'polite');
          errorDiv.textContent = errorMessage;
          formGroup.appendChild(errorDiv);
          
          // Add suggestion if it's a typo correction
          if (errorMessage.includes('Did you mean')) {
            const suggestionDiv = document.createElement('div');
            suggestionDiv.className = 'field-suggestion';
            suggestionDiv.innerHTML = `
              <button type="button" class="suggestion-btn" onclick="applySuggestion('${input.id}', '${errorMessage.split('Did you mean ')[1].split('?')[0]}')">
                Apply suggestion
              </button>
            `;
            formGroup.appendChild(suggestionDiv);
          }
        }
        
        // Add success message if valid and has content
        if (isValid && input.value.length > 0 && successMessage) {
          const successDiv = document.createElement('div');
          successDiv.className = 'field-success';
          successDiv.style.cssText = `
            color: var(--success-color);
            font-size: 0.8rem;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
          `;
          successDiv.innerHTML = `<span style="color: var(--success-color);">✓</span> ${successMessage}`;
          formGroup.appendChild(successDiv);
        }
        
      } catch (error) {
        console.error('Error in updateFieldValidation:', error);
      }
    }

    // Apply email suggestion
    function applySuggestion(inputId, suggestion) {
      const input = document.getElementById(inputId);
      if (input) {
        input.value = suggestion;
        input.focus();
        
        // Trigger validation
        if (inputId === 'customer-email') {
          validateCustomerEmail();
        }
        
        showPaymentMessage('Email suggestion applied successfully!', 'info');
      }
    }

    // Enhanced error recovery system
    function initializeErrorRecovery() {
      // Add global error handler
      window.addEventListener('error', function(event) {
        console.error('Global error:', event.error);
        
        // Check if it's a payment-related error
        if (event.filename && event.filename.includes('square')) {
          showPaymentMessage('Payment system error detected. Refreshing payment form...', 'warning');
          setTimeout(() => {
            reinitializePaymentSystem();
          }, 2000);
        }
      });

      // Add unhandled promise rejection handler
      window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        
        if (event.reason && event.reason.message && event.reason.message.includes('Square')) {
          showPaymentMessage('Payment system error. Please try again.', 'error');
          event.preventDefault(); // Prevent console error
        }
      });
    }

    function reinitializePaymentSystem() {
      try {
        // Clear existing Square instance
        if (window.squarePayments && window.squarePayments.card) {
          window.squarePayments.card.destroy();
        }
        
        // Reinitialize
        if (typeof Square !== 'undefined') {
          window.squarePayments = new SquarePayments();
          window.squarePayments.initializeSquareSDK().then(() => {
            showPaymentMessage('Payment system refreshed successfully!', 'success');
            updateSubmitButtonState();
          }).catch(error => {
            showPaymentMessage('Failed to refresh payment system. Please reload the page.', 'error');
          });
        }
        
      } catch (error) {
        console.error('Failed to reinitialize payment system:', error);
        showPaymentMessage('Please reload the page to continue.', 'error');
      }
    }

    function updateSubmitButtonState() {
      const submitBtn = document.getElementById('payment-submit-btn');
      if (!submitBtn) return;
      
      const isAmountValid = validatePaymentAmount();
      const isEmailValid = validateCustomerEmail();
      const isNameValid = validateCustomerName();
      const isPhoneValid = validateCustomerPhone();
      const isSquareReady = window.squarePayments && window.squarePayments.isInitialized;
      const isOnline = navigator.onLine;
      
      const allValid = isAmountValid && isEmailValid && isNameValid && isPhoneValid && isSquareReady && isOnline;
      submitBtn.disabled = !allValid;
      
      // Update button text with enhanced feedback
      const btnText = submitBtn.querySelector('.btn-text');
      if (btnText) {
        if (!isOnline) {
          btnText.textContent = '❌ No Internet Connection';
          showPaymentMessage('⚠️ Internet connection required to process payments. Please check your connection.', 'warning');
        } else if (!isSquareReady) {
          btnText.textContent = '⏳ Loading Payment System...';
        } else if (selectedCardId && !isUsingNewCard) {
          btnText.textContent = '💳 Process Payment with Saved Card';
        } else {
          btnText.textContent = '💰 Process Payment';
        }
      }
      
      // Provide feedback on validation status
      if (allValid && isOnline && isSquareReady) {
        // Clear any previous validation warnings
        const existingValidationMessages = document.querySelectorAll('.payment-message-warning');
        existingValidationMessages.forEach(msg => {
          if (msg.textContent.includes('validation') || msg.textContent.includes('required')) {
            msg.remove();
          }
        });
      }
    }

    // Network status handling with enhanced feedback
    function handleNetworkStatusChange() {
      const isOnline = navigator.onLine;
      const networkStatus = document.getElementById('network-status') || createNetworkStatusIndicator();
      
      if (!isOnline) {
        networkStatus.style.display = 'block';
        networkStatus.className = 'network-status offline';
        networkStatus.innerHTML = `
          <span class="status-icon">⚠️</span>
          <span>No internet connection. Payment processing unavailable. Please check your network and try again.</span>
        `;
        showPaymentMessage('🌐 Internet connection lost. Payment processing is temporarily unavailable. Please check your connection and try again.', 'warning');
      } else {
        networkStatus.style.display = 'none';
        // Clear network-related error messages
        clearNetworkErrorMessages();
        
        // Show connection restored message
        showPaymentMessage('🌐 Internet connection restored. Payment processing is now available.', 'success');
        
        // Auto-clear the success message after 3 seconds
        setTimeout(() => {
          const messages = document.querySelectorAll('.payment-message-success');
          messages.forEach(msg => {
            if (msg.textContent.includes('connection restored')) {
              msg.remove();
            }
          });
        }, 3000);
      }
      
      updateSubmitButtonState();
    }

    function createNetworkStatusIndicator() {
      const indicator = document.createElement('div');
      indicator.id = 'network-status';
      indicator.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #ff9800;
        color: white;
        padding: 10px;
        text-align: center;
        z-index: 9999;
        display: none;
        font-weight: 500;
      `;
      document.body.appendChild(indicator);
      return indicator;
    }

    function clearNetworkErrorMessages() {
      const messages = document.querySelectorAll('.payment-message');
      messages.forEach(message => {
        if (message.textContent.includes('connection') || message.textContent.includes('network')) {
          message.remove();
        }
      });
    }

    // Enhanced payment submission handler with comprehensive error handling
    function handlePaymentSubmit(event) {
      event.preventDefault();
      
      try {
        // Clear any existing messages
        clearPaymentMessages();
        
        // Check network connectivity
        if (!navigator.onLine) {
          showPaymentMessage('No internet connection. Please check your network and try again.', 'error');
          return;
        }
        
        // Check Square SDK initialization
        if (!window.squarePayments || !window.squarePayments.isInitialized) {
          showPaymentMessage('Payment system not initialized. Please refresh the page and try again.', 'error');
          return;
        }

        // Comprehensive form validation
        const validationResults = performComprehensiveValidation();
        if (!validationResults.isValid) {
          showPaymentMessage(validationResults.firstError, 'error');
          focusFirstErrorField(validationResults.errors);
          return;
        }

        // Check for duplicate submission
        if (isProcessingPayment) {
          showPaymentMessage('⚠️ Payment is already being processed. Please wait.', 'warning');
          return;
        }

        // Show payment confirmation dialog
        const formData = getPaymentFormData();
        const paymentMethod = !isUsingNewCard && selectedCardId ? 'saved card' : 'new card';
        const confirmMessage = `Confirm payment of $${(formData.amount / 100).toFixed(2)} to ${formData.customerInfo.name} (${formData.customerInfo.email}) using ${paymentMethod}?`;
        
        if (!confirm(confirmMessage)) {
          showPaymentMessage('❌ Payment cancelled by user.', 'info');
          return;
        }

        // Set processing flag
        isProcessingPayment = true;
        
        showPaymentMessage('🚀 Initiating payment process...', 'info');

        // Check if using saved card or new card
        if (!isUsingNewCard && selectedCustomerId && selectedCardId) {
          processSavedCardPayment();
        } else {
          processNewCardPayment();
        }

      } catch (error) {
        console.error('Payment submission error:', error);
        showPaymentMessage('An unexpected error occurred. Please try again.', 'error');
        isProcessingPayment = false;
      }
    }

    // Global flag to prevent duplicate submissions
    let isProcessingPayment = false;

    function performComprehensiveValidation() {
      const errors = {};
      
      // Validate all fields
      if (!validatePaymentAmount()) {
        errors.amount = 'Invalid payment amount';
      }
      
      if (!validateCustomerEmail()) {
        errors.email = 'Invalid email address';
      }
      
      if (!validateCustomerName()) {
        errors.name = 'Invalid customer name';
      }
      
      if (!validateCustomerPhone()) {
        errors.phone = 'Invalid phone number';
      }

      // Additional business logic validation
      const amount = parseFloat(document.getElementById('payment-amount').value);
      if (amount > 10000) {
        errors.amount = 'Large payments require additional verification. Please contact support.';
      }

      const isValid = Object.keys(errors).length === 0;
      const firstError = isValid ? null : Object.values(errors)[0];

      return {
        isValid,
        errors,
        firstError
      };
    }

    function focusFirstErrorField(errors) {
      const fieldMap = {
        amount: 'payment-amount',
        email: 'customer-email',
        name: 'customer-name',
        phone: 'customer-phone'
      };

      const firstErrorField = Object.keys(errors)[0];
      const fieldId = fieldMap[firstErrorField];
      
      if (fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
          field.focus();
          field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }

    function processNewCardPayment() {
      try {
        // Get form data
        const formData = getPaymentFormData();
        
        // Show processing state
        showProcessingState(true);
        
        // Add timeout for payment processing
        const paymentTimeout = setTimeout(() => {
          showPaymentMessage('Payment is taking longer than expected. Please wait...', 'warning');
        }, 10000);
        
        // Process payment with new card
        window.squarePayments.processPayment(formData.amount, formData.customerInfo)
          .then(result => {
            clearTimeout(paymentTimeout);
            showProcessingState(false);
            isProcessingPayment = false;
            
            if (result.success) {
              handlePaymentSuccess(result);
            } else {
              handlePaymentError(result.error || 'Payment processing failed');
            }
          })
          .catch(error => {
            clearTimeout(paymentTimeout);
            showProcessingState(false);
            isProcessingPayment = false;
            
            const errorMessage = formatPaymentError(error);
            handlePaymentError(errorMessage);
          });

      } catch (error) {
        console.error('New card payment error:', error);
        showProcessingState(false);
        isProcessingPayment = false;
        handlePaymentError('Failed to process payment. Please try again.');
      }
    }

    function processSavedCardPayment() {
      try {
        // Get form data
        const formData = getPaymentFormData();
        
        // Validate saved card selection
        if (!selectedCustomerId || !selectedCardId) {
          throw new Error('No saved payment method selected');
        }
        
        // Show processing state
        showProcessingState(true);
        
        // Add timeout for payment processing
        const paymentTimeout = setTimeout(() => {
          showPaymentMessage('Payment is taking longer than expected. Please wait...', 'warning');
        }, 10000);
        
        // Process payment with saved card
        window.squarePayments.processPaymentWithSavedCard(
          formData.amount, 
          selectedCustomerId, 
          selectedCardId, 
          formData.customerInfo
        )
          .then(result => {
            clearTimeout(paymentTimeout);
            showProcessingState(false);
            isProcessingPayment = false;
            
            if (result.success) {
              handleSavedCardPaymentSuccess(result);
            } else {
              handlePaymentError(result.error || 'Payment processing failed');
            }
          })
          .catch(error => {
            clearTimeout(paymentTimeout);
            showProcessingState(false);
            isProcessingPayment = false;
            
            const errorMessage = formatPaymentError(error);
            handlePaymentError(errorMessage);
          });

      } catch (error) {
        console.error('Saved card payment error:', error);
        showProcessingState(false);
        isProcessingPayment = false;
        handlePaymentError(error.message || 'Failed to process payment with saved card. Please try again.');
      }
    }

    function formatPaymentError(error) {
      const message = error.message || error.toString();
      
      // Network-related errors
      if (message.includes('fetch') || message.includes('network') || message.includes('timeout')) {
        return 'Network error occurred. Please check your connection and try again.';
      }
      
      // Square-specific errors
      if (message.includes('CARD_DECLINED')) {
        return 'Your card was declined. Please try a different payment method.';
      }
      
      if (message.includes('INSUFFICIENT_FUNDS')) {
        return 'Insufficient funds. Please try a different payment method.';
      }
      
      if (message.includes('INVALID_CARD')) {
        return 'Invalid card information. Please check your card details.';
      }
      
      if (message.includes('EXPIRED_CARD')) {
        return 'Your card has expired. Please use a different card.';
      }
      
      // Generic fallback
      return message.length > 100 ? 'Payment processing failed. Please try again.' : message;
    }

    function handlePaymentSuccess(result) {
      // Show detailed success message with enhanced feedback
      const customerName = document.getElementById('customer-name').value;
      const customerEmail = document.getElementById('customer-email').value;
      const amount = (result.amount / 100).toFixed(2);
      
      showPaymentMessage(
        `✅ Payment Successful! $${amount} charged to card ending in ${result.last4}. Transaction ID: ${result.transactionId}. Receipt will be sent to ${customerEmail}.`,
        'success'
      );
      
      // Add to transaction history
      addTransactionToHistory({
        transactionId: result.transactionId,
        amount: result.amount,
        customerName: customerName,
        customerEmail: customerEmail,
        last4: result.last4,
        status: 'completed',
        timestamp: new Date().toISOString()
      });
      
      // Check if card should be saved (only for new card payments)
      const saveCardCheckbox = document.getElementById('save-card');
      if (saveCardCheckbox && saveCardCheckbox.checked && isUsingNewCard) {
        showPaymentMessage('💳 Saving payment method for future use...', 'info');
        saveCustomerCard();
      }
      
      // Show next steps feedback
      setTimeout(() => {
        showPaymentMessage('📧 Payment confirmation email sent. You can process another payment or view transaction history below.', 'info');
      }, 2000);
      
      // Reset form after delay with user feedback
      setTimeout(() => {
        showPaymentMessage('🔄 Form cleared and ready for next payment.', 'info');
        resetPaymentForm();
      }, 5000);
    }

    function handlePaymentError(errorMessage) {
      try {
        // Log error for debugging
        console.error('Payment error:', errorMessage);
        
        // Show user-friendly error message
        showPaymentMessage(`Payment failed: ${errorMessage}`, 'error');
        
        // Add failed transaction to history
        const formData = getPaymentFormData();
        addTransactionToHistory({
          transactionId: 'failed_' + Date.now(),
          amount: formData.amount,
          customerName: formData.customerInfo.name,
          customerEmail: formData.customerInfo.email,
          status: 'failed',
          timestamp: new Date().toISOString(),
          error: errorMessage
        });

        // Provide recovery suggestions based on error type
        setTimeout(() => {
          showRecoverySuggestions(errorMessage);
        }, 2000);

        // Track error for analytics (in production)
        trackPaymentError(errorMessage, formData);

      } catch (error) {
        console.error('Error in handlePaymentError:', error);
        showPaymentMessage('An unexpected error occurred. Please refresh the page and try again.', 'error');
      }
    }

    function showRecoverySuggestions(errorMessage) {
      const lowerError = errorMessage.toLowerCase();
      let suggestion = '';

      if (lowerError.includes('declined') || lowerError.includes('insufficient')) {
        suggestion = 'Try using a different payment method or contact your bank.';
      } else if (lowerError.includes('network') || lowerError.includes('connection')) {
        suggestion = 'Check your internet connection and try again.';
      } else if (lowerError.includes('expired') || lowerError.includes('invalid')) {
        suggestion = 'Please verify your card information and try again.';
      } else if (lowerError.includes('timeout')) {
        suggestion = 'The request timed out. Please try again in a moment.';
      } else {
        suggestion = 'Please try again or contact support if the problem persists.';
      }

      if (suggestion) {
        showPaymentMessage(`Suggestion: ${suggestion}`, 'info');
      }
    }

    function trackPaymentError(errorMessage, formData) {
      try {
        // In production, this would send error data to analytics service
        const errorData = {
          error: errorMessage,
          amount: formData.amount,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          url: window.location.href
        };
        
        console.log('Payment error tracked:', errorData);
        
        // Store locally for debugging
        const errors = JSON.parse(localStorage.getItem('payment_errors') || '[]');
        errors.push(errorData);
        
        // Keep only last 10 errors
        if (errors.length > 10) {
          errors.splice(0, errors.length - 10);
        }
        
        localStorage.setItem('payment_errors', JSON.stringify(errors));
        
      } catch (error) {
        console.error('Failed to track payment error:', error);
      }
    }

    function saveCustomerCard() {
      const formData = getPaymentFormData();
      
      showPaymentMessage('💾 Saving payment method securely...', 'info');
      
      window.squarePayments.saveCustomerCard(formData.customerInfo)
        .then(result => {
          if (result.success) {
            showPaymentMessage(
              `✅ Payment method saved! ${result.brand} ending in ${result.last4} is now available for future payments.`,
              'success'
            );
            // Add customer to sidebar
            addCustomerToSidebar(formData.customerInfo, result);
            
            // Additional security feedback
            setTimeout(() => {
              showPaymentMessage('🔒 Payment method encrypted and stored securely with Square. No card details stored locally.', 'info');
            }, 2000);
          }
        })
        .catch(error => {
          console.error('Failed to save card:', error);
          showPaymentMessage('⚠️ Payment successful, but failed to save payment method for future use. Card details were not stored.', 'warning');
        });
    }

    function handleSavedCardPaymentSuccess(result) {
      // Show detailed success message for saved card payment
      const customerName = document.getElementById('customer-name').value;
      const customerEmail = document.getElementById('customer-email').value;
      const amount = (result.amount / 100).toFixed(2);
      
      showPaymentMessage(
        `✅ Payment Successful! $${amount} charged to saved card ending in ${result.last4}. Transaction ID: ${result.transactionId}. Receipt sent to ${customerEmail}.`,
        'success'
      );
      
      // Add to transaction history
      addTransactionToHistory({
        transactionId: result.transactionId,
        amount: result.amount,
        customerName: customerName,
        customerEmail: customerEmail,
        last4: result.last4,
        status: 'completed',
        timestamp: new Date().toISOString(),
        paymentMethod: 'saved_card'
      });
      
      // Show additional feedback for saved card usage
      setTimeout(() => {
        showPaymentMessage('💳 Payment processed using securely stored payment method. Customer card information remains protected.', 'info');
      }, 2000);
      
      // Reset form after delay with user feedback
      setTimeout(() => {
        showPaymentMessage('🔄 Form cleared and ready for next payment.', 'info');
        resetPaymentForm();
      }, 5000);
    }

    function resetPaymentForm() {
      // Clear amount and description
      document.getElementById('payment-amount').value = '';
      document.getElementById('payment-description').value = '';
      
      // Clear messages
      clearPaymentMessages();
      
      // If using new card, reset the Square form
      if (isUsingNewCard && window.squarePayments) {
        window.squarePayments.resetForm();
      }
      
      // Update submit button state
      updateSubmitButtonState();
    }

    function getPaymentFormData() {
      const amountInput = document.getElementById('payment-amount');
      const nameInput = document.getElementById('customer-name');
      const emailInput = document.getElementById('customer-email');
      const phoneInput = document.getElementById('customer-phone');
      const descriptionInput = document.getElementById('payment-description');

      return {
        amount: Math.round(parseFloat(amountInput.value) * 100), // Convert to cents
        customerInfo: {
          name: nameInput.value.trim(),
          email: emailInput.value.trim(),
          phone: phoneInput.value.trim() || null,
          description: descriptionInput.value.trim() || null
        }
      };
    }

    function showProcessingState(isProcessing) {
      const submitBtn = document.getElementById('payment-submit-btn');
      const processingIndicator = document.getElementById('processing-indicator');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnSpinner = submitBtn.querySelector('.btn-spinner');
      
      if (isProcessing) {
        submitBtn.disabled = true;
        btnSpinner.classList.remove('hidden');
        processingIndicator.classList.remove('hidden');
        
        // Enhanced processing feedback based on payment method
        if (!isUsingNewCard && selectedCardId) {
          btnText.textContent = 'Processing with Saved Card...';
          showPaymentMessage('🔒 Processing payment with securely stored payment method...', 'info');
        } else {
          btnText.textContent = 'Processing Payment...';
          showPaymentMessage('🔒 Securely processing payment through Square...', 'info');
        }
        
        // Disable form inputs with visual feedback
        const inputs = document.querySelectorAll('#payment-form input, #payment-form button');
        inputs.forEach(input => {
          input.disabled = true;
          input.style.opacity = '0.6';
        });
        
        // Add processing steps feedback
        setTimeout(() => {
          showPaymentMessage('🔐 Validating payment information...', 'info');
        }, 1000);
        
        setTimeout(() => {
          showPaymentMessage('💳 Communicating with payment processor...', 'info');
        }, 3000);
        
      } else {
        btnSpinner.classList.add('hidden');
        processingIndicator.classList.add('hidden');
        
        // Re-enable form inputs with visual feedback
        const inputs = document.querySelectorAll('#payment-form input, #payment-form button');
        inputs.forEach(input => {
          input.disabled = false;
          input.style.opacity = '1';
        });
        
        // Update submit button state based on validation
        updateSubmitButtonState();
        
        // Clear processing messages
        setTimeout(() => {
          clearProcessingMessages();
        }, 1000);
      }
    }
    
    function clearProcessingMessages() {
      const messages = document.querySelectorAll('.payment-message-info');
      messages.forEach(message => {
        if (message.textContent.includes('🔒') || 
            message.textContent.includes('🔐') || 
            message.textContent.includes('💳')) {
          message.remove();
        }
      });
    }

    function showPaymentMessage(message, type = 'info') {
      const messagesContainer = document.getElementById('payment-messages');
      if (!messagesContainer) return;

      const messageElement = document.createElement('div');
      messageElement.className = `payment-message payment-message-${type}`;
      messageElement.innerHTML = `
        <strong>${type === 'error' ? 'Error:' : type === 'success' ? 'Success:' : 'Info:'}</strong> ${message}
      `;

      messagesContainer.appendChild(messageElement);

      // Auto-hide success and info messages after 8 seconds
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          if (messageElement.parentNode) {
            messageElement.remove();
          }
        }, 8000);
      }

      // Scroll message into view
      messageElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function clearPaymentMessages() {
      const messagesContainer = document.getElementById('payment-messages');
      if (messagesContainer) {
        messagesContainer.innerHTML = '';
      }
    }

    function addTransactionToHistory(transaction) {
      const transactionsList = document.getElementById('transactions-list');
      if (!transactionsList) return;

      // Remove empty state if it exists
      const emptyState = transactionsList.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }

      // Create transaction element
      const transactionElement = document.createElement('div');
      transactionElement.className = 'transaction-item';
      
      const statusClass = transaction.status === 'completed' ? 'status-completed' : 
                         transaction.status === 'failed' ? 'status-failed' : 'status-pending';
      
      const amount = transaction.status === 'completed' ? 
        `$${(transaction.amount / 100).toFixed(2)}` : 
        `$${(transaction.amount / 100).toFixed(2)} (Failed)`;

      transactionElement.innerHTML = `
        <div class="transaction-info">
          <div class="transaction-customer">${transaction.customerName}</div>
          <div class="transaction-details">
            ${transaction.customerEmail} • ${new Date(transaction.timestamp).toLocaleString()}
            ${transaction.last4 ? ` • Card ending in ${transaction.last4}` : ''}
            ${transaction.error ? ` • ${transaction.error}` : ''}
          </div>
        </div>
        <div class="transaction-amount">${amount}</div>
        <div class="transaction-status ${statusClass}">${transaction.status}</div>
      `;

      // Add to top of list
      transactionsList.insertBefore(transactionElement, transactionsList.firstChild);

      // Limit to 10 transactions
      const transactions = transactionsList.querySelectorAll('.transaction-item');
      if (transactions.length > 10) {
        transactions[transactions.length - 1].remove();
      }
    }

    // Global variables for customer management
    let selectedCustomerId = null;
    let selectedCardId = null;
    let isUsingNewCard = true;

    function loadAndDisplayCustomers() {
      if (!window.squarePayments) return;
      
      const customers = window.squarePayments.getStoredCustomers();
      displayCustomers(customers);
    }

    function searchAndDisplayCustomers(query) {
      if (!window.squarePayments) return;
      
      const customers = window.squarePayments.searchCustomers(query);
      displayCustomers(customers);
    }

    function performCustomerSearch() {
      if (!window.squarePayments) return;
      
      const query = document.getElementById('customer-search-input').value;
      const filter = document.getElementById('customer-filter').value;
      const sort = document.getElementById('customer-sort').value;
      
      let customers;
      
      if (query) {
        customers = window.squarePayments.searchCustomers(query);
      } else {
        customers = window.squarePayments.getAllCustomersWithCards();
      }
      
      // Apply filters
      switch (filter) {
        case 'with-cards':
          customers = customers.filter(c => c.cards && c.cards.length > 0);
          break;
        case 'without-cards':
          customers = customers.filter(c => !c.cards || c.cards.length === 0);
          break;
        case 'recent':
          const weekAgo = new Date();
          weekAgo.setDate(weekAgo.getDate() - 7);
          customers = customers.filter(c => {
            const lastActivity = getCustomerLastActivity(c);
            return lastActivity && lastActivity > weekAgo;
          });
          break;
      }
      
      // Apply sorting
      customers.sort((a, b) => {
        switch (sort) {
          case 'name':
            return a.name.localeCompare(b.name);
          case 'email':
            return a.email.localeCompare(b.email);
          case 'created':
            return new Date(b.createdAt) - new Date(a.createdAt);
          case 'activity':
          default:
            const aActivity = getCustomerLastActivity(a) || new Date(a.createdAt);
            const bActivity = getCustomerLastActivity(b) || new Date(b.createdAt);
            return bActivity - aActivity;
        }
      });
      
      displayCustomers(customers);
      
      // Update search results count
      updateSearchResultsCount(customers.length, query, filter);
    }

    function updateSearchResultsCount(count, query, filter) {
      const helpElement = document.getElementById('customer-search-help');
      if (!helpElement) return;
      
      let message = '';
      
      if (query) {
        message = `Found ${count} customer${count !== 1 ? 's' : ''} matching "${query}"`;
      } else if (filter !== 'all') {
        const filterNames = {
          'with-cards': 'with saved cards',
          'without-cards': 'without saved cards',
          'recent': 'with recent activity'
        };
        message = `Showing ${count} customer${count !== 1 ? 's' : ''} ${filterNames[filter]}`;
      } else {
        message = `Showing all ${count} customer${count !== 1 ? 's' : ''}`;
      }
      
      helpElement.textContent = message;
    }

    function displayCustomers(customers) {
      const customerList = document.getElementById('customer-list');
      if (!customerList) return;

      // Clear existing content
      customerList.innerHTML = '';

      if (customers.length === 0) {
        customerList.innerHTML = `
          <div class="empty-state">
            <p>No customers found</p>
            <p class="empty-state-subtitle">Try a different search term or process a payment to create customers</p>
          </div>
        `;
        return;
      }

      customers.forEach(customer => {
        const customerElement = createCustomerElement(customer);
        customerList.appendChild(customerElement);
      });
    }

    function createCustomerElement(customer) {
      const customerElement = document.createElement('div');
      customerElement.className = 'customer-item';
      customerElement.dataset.customerId = customer.customerId;
      customerElement.dataset.email = customer.email;
      
      const cardCount = customer.cards ? customer.cards.length : 0;
      let cardText = '';
      let cardDetails = '';
      
      if (cardCount === 0) {
        cardText = 'No saved cards';
      } else if (cardCount === 1) {
        cardText = '1 saved card';
        const card = customer.cards[0];
        cardDetails = `${card.brand || 'Unknown'} •••• ${card.last4 || '****'}`;
      } else {
        cardText = `${cardCount} saved cards`;
        // Show primary card or most recent
        const primaryCard = customer.cards.find(c => c.isPrimary) || 
                           customer.cards.sort((a, b) => 
                             new Date(b.lastUsed || b.createdAt) - new Date(a.lastUsed || a.createdAt)
                           )[0];
        if (primaryCard) {
          cardDetails = `Primary: ${primaryCard.brand || 'Unknown'} •••• ${primaryCard.last4 || '****'}`;
        }
      }
      
      // Format last activity
      const lastActivity = getCustomerLastActivity(customer);
      const activityText = lastActivity ? 
        `Last activity: ${formatRelativeTime(lastActivity)}` : 
        `Created: ${formatRelativeTime(customer.createdAt)}`;
      
      customerElement.innerHTML = `
        <div class="customer-info">
          <div class="customer-name">${customer.name}</div>
          <div class="customer-email">${customer.email}</div>
          ${customer.phone ? `<div class="customer-phone">${customer.phone}</div>` : ''}
          <div class="customer-cards">${cardText}</div>
          ${cardDetails ? `<div class="customer-card-details">${cardDetails}</div>` : ''}
          <div class="customer-activity">${activityText}</div>
        </div>
        <div class="customer-actions">
          <button type="button" class="btn-link select-customer-btn">Select</button>
          ${cardCount > 0 ? '<button type="button" class="btn-link view-cards-btn">View Cards</button>' : ''}
        </div>
      `;

      // Add click handler to select customer
      const selectBtn = customerElement.querySelector('.select-customer-btn');
      selectBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        selectCustomer(customer);
      });

      // Add click handler to view cards
      const viewCardsBtn = customerElement.querySelector('.view-cards-btn');
      if (viewCardsBtn) {
        viewCardsBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          showCustomerCardsModal(customer);
        });
      }

      return customerElement;
    }

    function getCustomerLastActivity(customer) {
      const dates = [
        customer.createdAt,
        customer.updatedAt,
        ...(customer.cards || []).map(card => card.lastUsed || card.createdAt)
      ].filter(Boolean).map(date => new Date(date));
      
      return dates.length > 0 ? new Date(Math.max(...dates)) : null;
    }

    function formatRelativeTime(date) {
      const now = new Date();
      const diffMs = now - new Date(date);
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      
      if (diffDays > 7) {
        return new Date(date).toLocaleDateString();
      } else if (diffDays > 0) {
        return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      } else if (diffHours > 0) {
        return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      } else if (diffMinutes > 0) {
        return `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
      } else {
        return 'Just now';
      }
    }

    function showCustomerCardsModal(customer) {
      const modal = document.createElement('div');
      modal.className = 'customer-cards-modal';
      modal.innerHTML = `
        <div class="modal-overlay" onclick="this.closest('.customer-cards-modal').remove()"></div>
        <div class="modal-content">
          <div class="modal-header">
            <h3>Payment Methods for ${customer.name}</h3>
            <button class="modal-close" onclick="this.closest('.customer-cards-modal').remove()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="customer-cards-list">
              ${customer.cards.map(card => `
                <div class="card-item ${card.isPrimary ? 'primary-card' : ''}">
                  <div class="card-info">
                    <div class="card-brand-last4">${card.brand || 'Unknown'} •••• ${card.last4 || '****'}</div>
                    <div class="card-expiry">Expires ${String(card.expirationMonth || 0).padStart(2, '0')}/${String(card.expirationYear || 0).slice(-2)}</div>
                    <div class="card-usage">
                      ${card.isPrimary ? 'Primary card • ' : ''}
                      Last used: ${card.lastUsed ? formatRelativeTime(card.lastUsed) : 'Never'}
                    </div>
                  </div>
                  <div class="card-actions">
                    <button type="button" class="btn-small btn-primary" onclick="selectCustomerAndCard('${customer.customerId}', '${card.cardId}')">
                      Use This Card
                    </button>
                    ${!card.isPrimary ? `<button type="button" class="btn-small btn-link" onclick="setPrimaryCard('${customer.customerId}', '${card.cardId}')">Set Primary</button>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function selectCustomerAndCard(customerId, cardId) {
      const customer = window.squarePayments.getCustomerById(customerId);
      if (customer) {
        selectCustomer(customer);
        setTimeout(() => {
          selectSavedCard(cardId);
          // Close modal
          const modal = document.querySelector('.customer-cards-modal');
          if (modal) modal.remove();
        }, 100);
      }
    }

    function setPrimaryCard(customerId, cardId) {
      const result = window.squarePayments.setCustomerPrimaryCard(customerId, cardId);
      if (result.success) {
        showPaymentMessage('Primary payment method updated successfully', 'success');
        // Refresh customer display
        loadAndDisplayCustomers();
        // Close and reopen modal to show updated info
        const modal = document.querySelector('.customer-cards-modal');
        if (modal) {
          modal.remove();
          const customer = window.squarePayments.getCustomerById(customerId);
          if (customer) {
            setTimeout(() => showCustomerCardsModal(customer), 100);
          }
        }
      } else {
        showPaymentMessage('Failed to update primary payment method', 'error');
      }
    }

    function selectCustomer(customer) {
      selectedCustomerId = customer.customerId;
      
      // Populate customer information with feedback
      document.getElementById('customer-name').value = customer.name;
      document.getElementById('customer-email').value = customer.email;
      if (customer.phone) {
        document.getElementById('customer-phone').value = customer.phone;
      }
      
      // Show saved payment methods if customer has cards
      if (customer.cards && customer.cards.length > 0) {
        showSavedPaymentMethods(customer.cards);
        showPaymentMessage(`👤 Selected customer: ${customer.name} (${customer.cards.length} saved payment method${customer.cards.length > 1 ? 's' : ''})`, 'info');
      } else {
        showNewCardForm();
        showPaymentMessage(`👤 Selected customer: ${customer.name} (no saved payment methods - new card required)`, 'info');
      }
      
      // Trigger validation
      validateCustomerName();
      validateCustomerEmail();
      updateSubmitButtonState();
      
      // Provide additional feedback about customer selection
      setTimeout(() => {
        showPaymentMessage('✅ Customer information loaded. Enter payment amount to continue.', 'info');
      }, 1000);
    }

    function showSavedPaymentMethods(cards) {
      const savedMethodsSection = document.getElementById('saved-payment-methods');
      const cardContainer = document.getElementById('card-container');
      const saveCardOption = document.querySelector('.save-card-option');
      
      if (!savedMethodsSection) return;
      
      // Show saved methods section
      savedMethodsSection.classList.remove('hidden');
      
      // Hide new card form initially
      cardContainer.style.display = 'none';
      saveCardOption.style.display = 'none';
      
      // Populate saved cards
      displaySavedCards(cards);
      
      isUsingNewCard = false;
    }

    function displaySavedCards(cards) {
      const savedCardsList = document.getElementById('saved-cards-list');
      if (!savedCardsList) return;
      
      savedCardsList.innerHTML = '';
      
      // Sort cards by usage (most recent first) and primary status
      const sortedCards = cards.sort((a, b) => {
        // Primary cards first
        if (a.isPrimary && !b.isPrimary) return -1;
        if (!a.isPrimary && b.isPrimary) return 1;
        
        // Then by last used
        const aLastUsed = new Date(a.lastUsed || a.createdAt || 0);
        const bLastUsed = new Date(b.lastUsed || b.createdAt || 0);
        return bLastUsed - aLastUsed;
      });
      
      sortedCards.forEach((card, index) => {
        const cardElement = createSavedCardElement(card, index === 0);
        savedCardsList.appendChild(cardElement);
      });
      
      // Auto-select the first (primary/most recent) card
      if (sortedCards.length > 0) {
        setTimeout(() => {
          selectSavedCard(sortedCards[0].cardId);
        }, 100);
      }
    }

    function createSavedCardElement(card, isRecommended = false) {
      const cardElement = document.createElement('div');
      cardElement.className = 'saved-card-item';
      cardElement.dataset.cardId = card.cardId;
      
      if (card.isPrimary) {
        cardElement.classList.add('primary-card');
      }
      
      const expirationText = card.expirationMonth && card.expirationYear ? 
        `${String(card.expirationMonth).padStart(2, '0')}/${String(card.expirationYear).slice(-2)}` : 
        'Unknown';
      
      // Check if card is expired
      const isExpired = card.expirationMonth && card.expirationYear && 
        new Date() > new Date(card.expirationYear, card.expirationMonth - 1);
      
      // Format last used
      const lastUsedText = card.lastUsed ? 
        `Last used: ${formatRelativeTime(card.lastUsed)}` : 
        `Added: ${formatRelativeTime(card.createdAt)}`;
      
      cardElement.innerHTML = `
        <div class="card-info">
          <div class="card-header">
            <div class="card-brand">${card.brand || 'Unknown'}</div>
            ${card.isPrimary ? '<span class="primary-badge">Primary</span>' : ''}
            ${isRecommended ? '<span class="recommended-badge">Recommended</span>' : ''}
            ${isExpired ? '<span class="expired-badge">Expired</span>' : ''}
          </div>
          <div class="card-details">•••• •••• •••• ${card.last4}</div>
          <div class="card-expiration ${isExpired ? 'expired' : ''}">
            Expires ${expirationText}
          </div>
          <div class="card-usage">${lastUsedText}</div>
        </div>
        <div class="card-actions">
          <button type="button" class="btn-primary btn-small select-card-btn" ${isExpired ? 'disabled' : ''}>
            ${isExpired ? 'Card Expired' : 'Use This Card'}
          </button>
          ${!card.isPrimary && !isExpired ? '<button type="button" class="btn-link btn-small set-primary-btn">Set Primary</button>' : ''}
          <button type="button" class="btn-link btn-small delete-card-btn" aria-label="Delete this card">Delete</button>
        </div>
      `;

      // Add event listeners
      const selectBtn = cardElement.querySelector('.select-card-btn');
      const deleteBtn = cardElement.querySelector('.delete-card-btn');
      const setPrimaryBtn = cardElement.querySelector('.set-primary-btn');
      
      if (selectBtn && !isExpired) {
        selectBtn.addEventListener('click', function() {
          selectSavedCard(card.cardId);
        });
      }
      
      if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
          deleteSavedCard(card.cardId);
        });
      }
      
      if (setPrimaryBtn) {
        setPrimaryBtn.addEventListener('click', function() {
          setPrimaryCardInList(card.cardId);
        });
      }

      return cardElement;
    }

    function setPrimaryCardInList(cardId) {
      if (!selectedCustomerId) return;
      
      const result = window.squarePayments.setCustomerPrimaryCard(selectedCustomerId, cardId);
      if (result.success) {
        showPaymentMessage('Primary payment method updated successfully', 'success');
        
        // Refresh the saved cards display
        const customer = window.squarePayments.getCustomerById(selectedCustomerId);
        if (customer && customer.cards) {
          displaySavedCards(customer.cards);
        }
      } else {
        showPaymentMessage('Failed to update primary payment method', 'error');
      }
    }

    function selectSavedCard(cardId) {
      selectedCardId = cardId;
      
      // Update UI to show selected card with enhanced feedback
      const cardElements = document.querySelectorAll('.saved-card-item');
      let selectedCardInfo = null;
      
      cardElements.forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.cardId === cardId) {
          el.classList.add('selected');
          // Get card info for feedback
          const cardBrand = el.querySelector('.card-brand').textContent;
          const cardLast4 = el.querySelector('.card-details').textContent.slice(-4);
          selectedCardInfo = { brand: cardBrand, last4: cardLast4 };
        }
      });
      
      // Update submit button text
      const submitBtn = document.getElementById('payment-submit-btn');
      if (submitBtn) {
        submitBtn.querySelector('.btn-text').textContent = '💳 Process Payment with Saved Card';
      }
      
      updateSubmitButtonState();
      
      // Enhanced feedback with card details
      if (selectedCardInfo) {
        showPaymentMessage(`💳 Selected ${selectedCardInfo.brand} ending in ${selectedCardInfo.last4}. Payment will be processed securely without re-entering card details.`, 'info');
      } else {
        showPaymentMessage('💳 Selected saved payment method', 'info');
      }
      
      // Additional security feedback
      setTimeout(() => {
        showPaymentMessage('🔒 Using securely stored payment method. Your card details are protected by Square\'s encryption.', 'info');
      }, 1500);
    }

    function deleteSavedCard(cardId) {
      if (!confirm('Are you sure you want to delete this saved payment method?')) {
        return;
      }
      
      if (!window.squarePayments || !selectedCustomerId) return;
      
      window.squarePayments.deleteCustomerCard(selectedCustomerId, cardId)
        .then(() => {
          showPaymentMessage('Payment method deleted successfully', 'success');
          
          // Refresh the customer display
          const customers = window.squarePayments.getStoredCustomers();
          const customer = customers.find(c => c.customerId === selectedCustomerId);
          
          if (customer && customer.cards.length > 0) {
            showSavedPaymentMethods(customer.cards);
          } else {
            showNewCardForm();
          }
          
          // Refresh customer list
          loadAndDisplayCustomers();
        })
        .catch(error => {
          showPaymentMessage(`Failed to delete payment method: ${error.message}`, 'error');
        });
    }

    function showNewCardForm() {
      const savedMethodsSection = document.getElementById('saved-payment-methods');
      const cardContainer = document.getElementById('card-container');
      const saveCardOption = document.querySelector('.save-card-option');
      const submitBtn = document.getElementById('payment-submit-btn');
      
      // Hide saved methods section
      if (savedMethodsSection) {
        savedMethodsSection.classList.add('hidden');
      }
      
      // Show new card form
      if (cardContainer) {
        cardContainer.style.display = 'block';
      }
      if (saveCardOption) {
        saveCardOption.style.display = 'block';
      }
      
      // Reset submit button text
      if (submitBtn) {
        submitBtn.querySelector('.btn-text').textContent = 'Process Payment';
      }
      
      selectedCardId = null;
      isUsingNewCard = true;
      updateSubmitButtonState();
    }

    function clearSelectedCustomer() {
      selectedCustomerId = null;
      selectedCardId = null;
      isUsingNewCard = true;
      
      // Clear form fields
      document.getElementById('customer-name').value = '';
      document.getElementById('customer-email').value = '';
      document.getElementById('customer-phone').value = '';
      
      // Clear search
      document.getElementById('customer-search-input').value = '';
      
      // Show new card form
      showNewCardForm();
      
      // Reload all customers
      loadAndDisplayCustomers();
      
      // Clear validation
      const inputs = ['customer-name', 'customer-email'];
      inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.classList.remove('valid', 'invalid');
          const formGroup = input.closest('.form-group');
          const existingError = formGroup.querySelector('.field-error');
          if (existingError) {
            existingError.remove();
          }
        }
      });
      
      updateSubmitButtonState();
    }

    function addCustomerToSidebar(customerInfo, cardInfo) {
      // Store the customer data using the square payments system
      if (window.squarePayments && cardInfo) {
        const customer = {
          customerId: cardInfo.customerId || 'cust_' + Date.now(),
          name: customerInfo.name,
          email: customerInfo.email,
          phone: customerInfo.phone || null,
          createdAt: new Date().toISOString()
        };
        
        window.squarePayments.storeCustomerCardLocally(customer, cardInfo);
      }
      
      // Refresh the customer display
      loadAndDisplayCustomers();
    }

    // Make squarePayments globally accessible
    window.addEventListener('load', function() {
      if (window.squarePayments) {
        console.log('Square Payments SDK ready');
      }
    });

    // Integration test function for complete workflow
    function runIntegrationTest() {
      console.log('Running integration test...');
      
      // Test 1: Admin authentication check
      const adminAuth = new AdminAuth();
      const isAdmin = adminAuth.isCurrentUserAdmin();
      const sessionValid = adminAuth.isAdminSessionValid();
      
      console.log('Admin authentication test:', {
        isAdmin: isAdmin,
        sessionValid: sessionValid,
        currentUser: adminAuth.currentUser
      });
      
      // Test 2: Navigation integration
      const paymentsNavItems = document.querySelectorAll('#payments-nav');
      console.log('Navigation integration test:', {
        paymentsNavCount: paymentsNavItems.length,
        paymentsNavVisible: paymentsNavItems.length > 0 && paymentsNavItems[0].style.display !== 'none'
      });
      
      // Test 3: Square SDK integration
      const squareReady = window.squarePayments && window.squarePayments.isInitialized;
      console.log('Square SDK integration test:', {
        squareLoaded: typeof Square !== 'undefined',
        squarePaymentsReady: squareReady,
        cardContainerExists: !!document.getElementById('card-container')
      });
      
      // Test 4: Form validation integration
      const formElements = {
        amountInput: !!document.getElementById('payment-amount'),
        nameInput: !!document.getElementById('customer-name'),
        emailInput: !!document.getElementById('customer-email'),
        submitButton: !!document.getElementById('payment-submit-btn')
      };
      console.log('Form integration test:', formElements);
      
      // Test 5: Customer management integration
      const customerElements = {
        customerList: !!document.getElementById('customer-list'),
        customerSearch: !!document.getElementById('customer-search-input'),
        savedPaymentMethods: !!document.getElementById('saved-payment-methods')
      };
      console.log('Customer management integration test:', customerElements);
      
      // Test 6: Transaction history integration
      const transactionElements = {
        transactionsList: !!document.getElementById('transactions-list')
      };
      console.log('Transaction history integration test:', transactionElements);
      
      // Overall integration status
      const integrationStatus = {
        adminAuthReady: isAdmin && sessionValid,
        navigationReady: paymentsNavItems.length > 0,
        paymentSystemReady: squareReady,
        formReady: Object.values(formElements).every(Boolean),
        customerMgmtReady: Object.values(customerElements).every(Boolean),
        transactionHistoryReady: Object.values(transactionElements).every(Boolean)
      };
      
      const allSystemsReady = Object.values(integrationStatus).every(Boolean);
      
      console.log('Integration test results:', {
        ...integrationStatus,
        allSystemsReady: allSystemsReady
      });
      
      // Show integration status to admin
      if (isAdmin) {
        const statusMessage = allSystemsReady ? 
          'All payment systems integrated and ready!' : 
          'Some payment systems need attention. Check console for details.';
        
        const statusType = allSystemsReady ? 'success' : 'warning';
        
        setTimeout(() => {
          showPaymentMessage(`Integration Status: ${statusMessage}`, statusType);
        }, 2000);
      }
      
      return integrationStatus;
    }

    // Run integration test after page load
    window.addEventListener('load', function() {
      // Wait a bit for all systems to initialize
      setTimeout(runIntegrationTest, 3000);
    });

    // Add keyboard shortcuts for admin testing
    document.addEventListener('keydown', function(event) {
      // Ctrl+Shift+T for integration test
      if (event.ctrlKey && event.shiftKey && event.key === 'T') {
        event.preventDefault();
        runIntegrationTest();
      }
      
      // Ctrl+Shift+R for reset demo data
      if (event.ctrlKey && event.shiftKey && event.key === 'R') {
        event.preventDefault();
        if (confirm('Reset all demo data? This will clear customers, transactions, and form data.')) {
          resetDemoData();
        }
      }
      
      // Ctrl+Shift+D for demo payment workflow
      if (event.ctrlKey && event.shiftKey && event.key === 'D') {
        event.preventDefault();
        runDemoPaymentWorkflow();
      }
    });

    // Demo payment workflow to test complete integration
    async function runDemoPaymentWorkflow() {
      try {
        showPaymentMessage('Starting demo payment workflow...', 'info');
        
        // Step 1: Fill in demo customer data
        document.getElementById('customer-name').value = 'John Demo Customer';
        document.getElementById('customer-email').value = 'john.demo@example.com';
        document.getElementById('customer-phone').value = '(555) 123-4567';
        document.getElementById('payment-amount').value = '99.99';
        document.getElementById('payment-description').value = 'Demo Payment - Integration Test';
        
        // Trigger validation
        validateCustomerName();
        validateCustomerEmail();
        validateCustomerPhone();
        validatePaymentAmount();
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        showPaymentMessage('Demo data filled. In a real scenario, you would now enter card details and submit.', 'info');
        
        // Step 2: Simulate successful payment (without actually processing)
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Add demo transaction to history
        addTransactionToHistory({
          transactionId: 'demo_' + Date.now(),
          amount: 9999, // $99.99 in cents
          customerName: 'John Demo Customer',
          customerEmail: 'john.demo@example.com',
          last4: '4242',
          status: 'completed',
          timestamp: new Date().toISOString()
        });
        
        // Step 3: Simulate saving customer
        const demoCustomer = {
          customerId: 'demo_cust_' + Date.now(),
          name: 'John Demo Customer',
          email: 'john.demo@example.com',
          phone: '(555) 123-4567',
          createdAt: new Date().toISOString(),
          cards: [{
            cardId: 'demo_card_' + Date.now(),
            last4: '4242',
            brand: 'Visa',
            expirationMonth: 12,
            expirationYear: 2025,
            createdAt: new Date().toISOString()
          }]
        };
        
        // Store demo customer
        const customers = JSON.parse(localStorage.getItem('square_customers') || '[]');
        customers.push(demoCustomer);
        localStorage.setItem('square_customers', JSON.stringify(customers));
        
        // Refresh customer display
        loadAndDisplayCustomers();
        
        showPaymentMessage('Demo workflow completed! Check transaction history and customer list.', 'success');
        
        console.log('Demo payment workflow completed successfully');
        
      } catch (error) {
        console.error('Demo workflow error:', error);
        showPaymentMessage('Demo workflow encountered an error. Check console for details.', 'error');
      }
    }

    // Show help panel with integration status and shortcuts
    function showHelpPanel() {
      // Run integration test to get current status
      const integrationStatus = runIntegrationTest();
      
      const helpPanel = document.createElement('div');
      helpPanel.className = 'help-panel';
      helpPanel.innerHTML = `
        <div class="help-content">
          <div class="help-header">
            <h2>Payment System Help</h2>
            <button class="help-close" onclick="this.closest('.help-panel').remove()">&times;</button>
          </div>
          
          <div class="help-section">
            <h3>System Status</h3>
            <ul class="shortcut-list">
              <li>
                <span><span class="status-indicator ${integrationStatus.adminAuthReady ? 'status-ready' : 'status-error'}"></span>Admin Authentication</span>
                <span>${integrationStatus.adminAuthReady ? 'Ready' : 'Not Ready'}</span>
              </li>
              <li>
                <span><span class="status-indicator ${integrationStatus.navigationReady ? 'status-ready' : 'status-error'}"></span>Navigation Integration</span>
                <span>${integrationStatus.navigationReady ? 'Ready' : 'Not Ready'}</span>
              </li>
              <li>
                <span><span class="status-indicator ${integrationStatus.paymentSystemReady ? 'status-ready' : 'status-error'}"></span>Square Payment System</span>
                <span>${integrationStatus.paymentSystemReady ? 'Ready' : 'Not Ready'}</span>
              </li>
              <li>
                <span><span class="status-indicator ${integrationStatus.formReady ? 'status-ready' : 'status-error'}"></span>Payment Form</span>
                <span>${integrationStatus.formReady ? 'Ready' : 'Not Ready'}</span>
              </li>
              <li>
                <span><span class="status-indicator ${integrationStatus.customerMgmtReady ? 'status-ready' : 'status-error'}"></span>Customer Management</span>
                <span>${integrationStatus.customerMgmtReady ? 'Ready' : 'Not Ready'}</span>
              </li>
              <li>
                <span><span class="status-indicator ${integrationStatus.transactionHistoryReady ? 'status-ready' : 'status-error'}"></span>Transaction History</span>
                <span>${integrationStatus.transactionHistoryReady ? 'Ready' : 'Not Ready'}</span>
              </li>
            </ul>
          </div>
          
          <div class="help-section">
            <h3>Keyboard Shortcuts</h3>
            <ul class="shortcut-list">
              <li>
                <span>Run Integration Test</span>
                <span class="shortcut-key">Ctrl+Shift+T</span>
              </li>
              <li>
                <span>Reset Demo Data</span>
                <span class="shortcut-key">Ctrl+Shift+R</span>
              </li>
              <li>
                <span>Demo Payment Workflow</span>
                <span class="shortcut-key">Ctrl+Shift+D</span>
              </li>
            </ul>
          </div>
          
          <div class="help-section">
            <h3>Integration Features</h3>
            <ul>
              <li><strong>Admin Authentication:</strong> Secure access control with hardcoded admin credentials</li>
              <li><strong>Navigation Integration:</strong> Dynamic "Payments" menu item for authenticated admins</li>
              <li><strong>Payment Processing:</strong> Square Web Payments SDK integration with tokenization</li>
              <li><strong>Customer Management:</strong> Secure card storage and customer search functionality</li>
              <li><strong>Transaction History:</strong> Real-time transaction logging and display</li>
              <li><strong>Error Handling:</strong> Comprehensive error recovery and user feedback</li>
            </ul>
          </div>
          
          <div class="help-section">
            <h3>Workflow</h3>
            <ol>
              <li>Admin logs in with credentials (Minty-Komodo, password, griffin@crowhurst.ws)</li>
              <li>"Payments" navigation item appears in menu</li>
              <li>Admin accesses payment page with full functionality</li>
              <li>Payment form validates input in real-time</li>
              <li>Square SDK processes payments securely</li>
              <li>Customer cards can be saved for future use</li>
              <li>Transaction history tracks all payment activity</li>
            </ol>
          </div>
        </div>
      `;
      
      document.body.appendChild(helpPanel);
      
      // Close on background click
      helpPanel.addEventListener('click', function(e) {
        if (e.target === helpPanel) {
          helpPanel.remove();
        }
      });
      
      // Close on Escape key
      document.addEventListener('keydown', function escapeHandler(e) {
        if (e.key === 'Escape') {
          helpPanel.remove();
          document.removeEventListener('keydown', escapeHandler);
        }
      });
    }

    function resetDemoData() {
      try {
        // Clear localStorage data
        localStorage.removeItem('square_customers');
        localStorage.removeItem('payment_errors');
        
        // Clear form
        document.getElementById('payment-form').reset();
        
        // Clear messages
        clearPaymentMessages();
        
        // Reset customer list
        loadAndDisplayCustomers();
        
        // Clear transaction history
        const transactionsList = document.getElementById('transactions-list');
        if (transactionsList) {
          transactionsList.innerHTML = `
            <div class="empty-state">
              <p>No transactions yet</p>
              <p class="empty-state-subtitle">Completed payments will appear here</p>
            </div>
          `;
        }
        
        // Reset Square form if available
        if (window.squarePayments) {
          window.squarePayments.resetForm();
        }
        
        showPaymentMessage('Demo data reset successfully!', 'success');
        
      } catch (error) {
        console.error('Error resetting demo data:', error);
        showPaymentMessage('Error resetting demo data. Please refresh the page.', 'error');
      }
    }
  </script>
</body>
</html>
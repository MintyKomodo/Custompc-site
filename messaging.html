<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Messaging | CustomPC.tech</title>
  <meta name="description" content="Live messaging with CustomPC.tech support team. Get real-time help with your custom PC build questions and technical support." />
  <meta name="keywords" content="live chat, custompc support, pc help, technical support, messaging" />
  <meta name="author" content="CustomPC.tech" />
  <meta property="og:title" content="Live Messaging | CustomPC.tech" />
  <meta property="og:description" content="Chat with our PC experts in real-time for instant help and support." />
  <meta property="og:url" content="https://custompc.tech/messaging.html" />
  <link rel="canonical" href="https://custompc.tech/messaging.html" />
  <link rel="icon" type="image/png" sizes="32x32" href="images/logo.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="images/logo.png" />
  <link rel="shortcut icon" href="images/logo.png" />
  <link rel="apple-touch-icon" href="images/logo.png" />
  
  <style>
    :root{
      --space:10px; --space-sm:6px; --space-lg:16px;
      --bg:#0a0f1a; --ink:#e9eefc; --muted:#aeb9d4;
      --panel:#111729; --panel2:#0d1426; --border:rgba(255,255,255,.08);
      --accent1:#7db2ff; --accent2:#7cf2e6;
      --radius:18px; --shadow:0 20px 40px rgba(0,0,0,.35);
      --max:1200px;
    }
    *{box-sizing:border-box}
    html{scrollbar-gutter:stable}
    body{
      margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial;color:var(--ink);
      background:radial-gradient(1200px 600px at 50% -10%, #0f162b 8%, transparent 55%), linear-gradient(#081021, #0a0f1a 40%, #0a0f1a);
      line-height:1.55;overflow-x:hidden;min-height:100vh;
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:var(--space-lg);width:100%;box-sizing:border-box}

    /* Header (shared) */
    header{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:var(--space-lg);padding:0 var(--space);
      max-width:var(--max);margin-left:auto;margin-right:auto;width:100%
    }
    .brand a{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;font-weight:700;letter-spacing:.3px;white-space:nowrap}
    nav{display:flex;gap:var(--space);flex-wrap:wrap}
    .pill{display:inline-block;padding:10px 14px;border-radius:999px;color:var(--ink);text-decoration:none;border:1px solid transparent}
    .pill:hover{background:#0f1830}
    .pill.active{background:linear-gradient(120deg,rgba(125,178,255,.15),rgba(124,242,230,.15));border-color:rgba(255,255,255,.08)}

    /* Messaging Interface */
    .messaging-container {
      display: flex;
      height: calc(100vh - 200px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    /* Chat Area (Left Side) */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
    }
    
    /* Contact Sidebar (Right Side) */
    .contact-sidebar {
      width: 300px;
      background: var(--panel2);
      display: flex;
      flex-direction: column;
    }
    
    .messaging-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(125,178,255,.1), rgba(124,242,230,.1));
    }
    
    /* Contact Info Header */
    .contact-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }
    
    .contact-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7db2ff, #7cf2e6);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 24px;
      font-weight: 600;
      color: #0b0f1a;
    }
    
    .contact-name {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 4px;
    }
    
    .contact-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 14px;
      color: var(--muted);
    }
    
    .contact-status.online {
      color: #00ff88;
    }
    
    /* Contact Details */
    .contact-details {
      padding: 20px;
      flex: 1;
    }
    
    .detail-section {
      margin-bottom: 24px;
    }
    
    .detail-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      font-size: 14px;
    }
    
    .detail-icon {
      width: 16px;
      text-align: center;
      color: var(--accent1);
    }
    
    .quick-actions-sidebar {
      padding: 20px;
      border-top: 1px solid var(--border);
    }
    
    .quick-action-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--ink);
      text-decoration: none;
      text-align: center;
      margin-bottom: 8px;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .quick-action-btn:hover {
      background: rgba(125, 178, 255, 0.1);
      border-color: rgba(125, 178, 255, 0.3);
    }
    
    /* Admin Chat Management */
    .admin-chat-sidebar {
      width: 300px;
      background: var(--panel2);
      border-right: 1px solid var(--border);
      display: none;
      flex-direction: column;
    }
    
    .admin-sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(125,178,255,.1), rgba(124,242,230,.1));
    }
    
    .admin-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    .admin-subtitle {
      font-size: 14px;
      color: var(--muted);
    }
    
    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    
    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .chat-item:hover {
      background: rgba(125, 178, 255, 0.1);
      border-color: rgba(125, 178, 255, 0.2);
    }
    
    .chat-item.active {
      background: rgba(125, 178, 255, 0.15);
      border-color: rgba(125, 178, 255, 0.3);
    }
    
    .chat-item.unread {
      background: rgba(255, 99, 132, 0.1);
      border-color: rgba(255, 99, 132, 0.2);
    }
    
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7db2ff, #7cf2e6);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 14px;
      font-weight: 600;
      color: #0b0f1a;
      flex-shrink: 0;
    }
    
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    
    .chat-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-preview {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    
    .chat-time {
      font-size: 11px;
      color: var(--muted);
    }
    
    .unread-badge {
      background: #ff6b6b;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }
    
    .admin-actions {
      padding: 16px;
      border-top: 1px solid var(--border);
    }
    
    .admin-btn {
      display: block;
      width: 100%;
      padding: 8px 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--ink);
      text-decoration: none;
      text-align: center;
      margin-bottom: 8px;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .admin-btn:hover {
      background: rgba(125, 178, 255, 0.1);
      border-color: rgba(125, 178, 255, 0.3);
    }
    
    .admin-btn.primary {
      background: linear-gradient(135deg, #7db2ff, #7cf2e6);
      color: #0b0f1a;
      border: none;
    }
    
    .empty-chats {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    
    .empty-chats-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    /* Admin layout adjustments */
    .messaging-container.admin-mode {
      display: flex;
    }
    
    .messaging-container.admin-mode .admin-chat-sidebar {
      display: flex;
    }
    
    .messaging-title {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 20px;
    }
    
    .live-indicator {
      width: 12px;
      height: 12px;
      background: #00ff88;
      border-radius: 50%;
      margin-right: 12px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .messaging-status {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: var(--panel2);
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      color: var(--muted);
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      background: #00ff88;
      animation: pulse 2s infinite;
    }
    
    .messaging-chat {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .message {
      display: flex;
      margin-bottom: 16px;
    }
    
    .message.user {
      justify-content: flex-end;
    }
    
    .message.admin {
      justify-content: flex-start;
    }
    
    .message.system {
      justify-content: center;
    }
    
    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    
    .message.system .message-content {
      background: rgba(125, 178, 255, 0.1);
      border: 1px solid rgba(125, 178, 255, 0.2);
      color: var(--ink);
      text-align: center;
      max-width: 90%;
    }
    
    .message.user .message-content {
      background: linear-gradient(135deg, #7db2ff, #7cf2e6);
      color: #0b0f1a;
      font-weight: 500;
    }
    
    .message.admin .message-content {
      background: var(--panel2);
      border: 1px solid var(--border);
      color: var(--ink);
    }
    
    .message-time {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      text-align: right;
    }
    
    .message.admin .message-time {
      text-align: left;
    }
    
    .messaging-input-container {
      display: flex;
      padding: 20px;
      border-top: 1px solid var(--border);
      gap: 12px;
      background: var(--panel);
    }
    
    .messaging-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel2);
      color: var(--ink);
      outline: none;
      font-size: 14px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
    }
    
    .messaging-input:focus {
      border-color: var(--accent1);
      box-shadow: 0 0 0 2px rgba(125, 178, 255, 0.2);
    }
    
    .send-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #7db2ff, #7cf2e6);
      color: #0b0f1a;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      white-space: nowrap;
    }
    
    .send-btn:hover {
      transform: translateY(-1px);
    }
    
    .send-btn:active {
      transform: translateY(0);
    }
    
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Welcome Section */
    .welcome-section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .welcome-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    .welcome-subtitle {
      color: var(--muted);
      margin-bottom: 16px;
    }
    
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    
    .quick-action {
      padding: 12px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
    }
    
    .quick-action:hover {
      background: rgba(125, 178, 255, 0.1);
      border-color: rgba(125, 178, 255, 0.3);
    }
    
    .quick-action-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .quick-action-desc {
      font-size: 13px;
      color: var(--muted);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .messaging-container {
        height: calc(100vh - 160px);
        flex-direction: column;
      }
      
      .contact-sidebar {
        width: 100%;
        height: 200px;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      
      .chat-area {
        border-right: none;
      }
      
      .messaging-input-container {
        padding: 16px;
      }
      
      .message-content {
        max-width: 85%;
      }
      
      .quick-actions {
        grid-template-columns: 1fr;
      }
      
      .contact-details {
        padding: 12px;
      }
      
      .detail-section {
        margin-bottom: 16px;
      }
    }
    
    /* Typing indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      color: var(--muted);
      font-size: 13px;
      font-style: italic;
    }
    
    .typing-dots {
      display: inline-flex;
      margin-left: 8px;
    }
    
    .typing-dots span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--muted);
      margin: 0 1px;
      animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header>
      <div class="brand">
        <a href="index.html">
          <img src="images/logo.png" alt="CustomPC.tech logo"
            style="height:100px;width:100px;display:inline-block;vertical-align:middle;object-fit:contain;border-radius:50%;" />
          <span style="margin-left:8px;vertical-align:middle;">CustomPC.tech</span>
        </a>
      </div>
      <nav>
        <a class="pill" href="builds.html">Builds</a>
        <a class="pill" href="index.html">Custom PC</a>
        <a class="pill" href="about.html">About</a>
        <a class="pill" href="contact.html">Contact</a>
        <a class="pill active" href="messaging.html">Live Chat</a>
      </nav>
    </header>

    <!-- Welcome Section -->
    <section class="welcome-section">
      <div class="welcome-title">
        <div class="live-indicator"></div>
        Live Messaging
      </div>
      <p class="welcome-subtitle">Chat with our PC experts in real-time for instant help and support</p>
      
      <div class="quick-actions">
        <div class="quick-action" onclick="startQuickChat('support')">
          <div class="quick-action-title">Technical Support</div>
          <div class="quick-action-desc">Get help with PC issues or questions</div>
        </div>
        
        <div class="quick-action" onclick="startQuickChat('quote')">
          <div class="quick-action-title">Get a Quote</div>
          <div class="quick-action-desc">Pricing for custom build projects</div>
        </div>
        
        <div class="quick-action" onclick="startQuickChat('general')">
          <div class="quick-action-title">General Question</div>
          <div class="quick-action-desc">Other inquiries and information</div>
        </div>
      </div>
    </section>

    <!-- Main Messaging Interface -->
    <div class="messaging-container" id="messaging-container">
      <!-- Admin Chat Sidebar (Left Side - Only for Admins) -->
      <div class="admin-chat-sidebar" id="admin-chat-sidebar">
        <div class="admin-sidebar-header">
          <div class="admin-title">Active Chats</div>
          <div class="admin-subtitle">Manage customer conversations</div>
        </div>
        
        <div class="chat-list" id="chat-list">
          <div class="empty-chats" id="empty-chats">
            <div class="empty-chats-icon">💬</div>
            <div>No active chats</div>
            <div style="font-size: 12px; margin-top: 8px;">Conversations will appear here when users start chatting</div>
          </div>
        </div>
        
        <div class="admin-actions">
          <button class="admin-btn primary" onclick="refreshChats()">Refresh Chats</button>
          <button class="admin-btn" onclick="markAllAsRead()">Mark All Read</button>
          <a href="payments.html" class="admin-btn">Payment System</a>
        </div>
      </div>
      
      <!-- Chat Area (Middle/Right Side) -->
      <div class="chat-area">
        <div class="messaging-header">
          <div class="messaging-title">
            <div class="live-indicator"></div>
            Live Chat Support
          </div>
          <div style="font-size: 14px; color: var(--muted);">
            <span id="connection-status">Connecting...</span>
          </div>
        </div>
        
        <div class="messaging-status">
          <div class="status-indicator"></div>
          <span id="status-text">Notifying our team to join the chat...</span>
        </div>
        
        <div class="messaging-chat" id="messaging-chat">
          <div class="message system">
            <div class="message-content">
              Welcome to CustomPC.tech live support!<br><br>
              We're notifying our team to join the chat. Please describe what you need help with and we'll be with you shortly.
            </div>
          </div>
        </div>
        
        <div class="messaging-input-container">
          <textarea 
            id="messaging-input" 
            class="messaging-input" 
            placeholder="Type your message here..."
            rows="1"
          ></textarea>
          <button id="send-btn" class="send-btn" onclick="sendMessage()">Send</button>
        </div>
      </div>
      
      <!-- Contact Sidebar (Right Side) -->
      <div class="contact-sidebar">
        <div class="contact-header">
          <div class="contact-avatar" id="contact-avatar">
            PC
          </div>
          <div class="contact-name" id="contact-name">CustomPC.tech Support</div>
          <div class="contact-status online" id="contact-status">
            <div class="status-indicator"></div>
            <span>Online - Ready to help</span>
          </div>
        </div>
        
        <div class="contact-details">
          <div class="detail-section">
            <div class="detail-title">Contact Information</div>
            <div class="detail-item">
              <div class="detail-icon"></div>
              <div>griffin@crowhurst.ws</div>
            </div>
            <div class="detail-item">
              <div class="detail-icon"></div>
              <div>CustomPC.tech</div>
            </div>
            <div class="detail-item">
              <div class="detail-icon"></div>
              <div>Response time: ~5 minutes</div>
            </div>
          </div>
          
          <div class="detail-section">
            <div class="detail-title">Session Info</div>
            <div class="detail-item">
              <div class="detail-icon"></div>
              <div id="session-time">Started just now</div>
            </div>
            <div class="detail-item">
              <div class="detail-icon"></div>
              <div><span id="message-count">1</span> messages</div>
            </div>
          </div>
        </div>
        
        <div class="quick-actions-sidebar">
          <div class="detail-title">Quick Actions</div>
          <a href="#" class="quick-action-btn" onclick="startQuickChat('support')">Technical Support</a>
          <a href="#" class="quick-action-btn" onclick="startQuickChat('quote')">Get Quote</a>
          <a href="#" class="quick-action-btn" onclick="startQuickChat('general')">General Question</a>
          <a href="contact.html" class="quick-action-btn">Email Instead</a>
        </div>
      </div>
    </div>
  </div>

  <script src="shared-auth.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <!-- Firebase Chat Manager -->
  <script src="firebase-config.js"></script>
  
  <script>
    class LiveMessagingPage {
      constructor() {
        this.messageQueue = [];
        this.isTyping = false;
        this.messageCount = 1;
        this.sessionStartTime = new Date();
        this.isAdmin = false;
        this.currentChatId = null;
        this.activeChats = new Map();
        this.init();
      }
      
      init() {
        this.checkAdminStatus();
        this.setupInputHandlers();
        this.initializeChatSession();
        this.updateConnectionStatus();
        this.autoResizeTextarea();
        this.updateSessionInfo();
        this.startSessionTimer();
        
        if (this.isAdmin) {
          this.setupAdminInterface();
        } else {
          this.notifyAdmin();
        }
      }
      
      checkAdminStatus() {
        const sharedAuth = window.sharedAuth;
        this.isAdmin = sharedAuth && sharedAuth.isCurrentUserAdmin();
        
        if (this.isAdmin) {
          document.getElementById('messaging-container').classList.add('admin-mode');
          console.log('Admin mode activated');
        }
      }
      
      setupInputHandlers() {
        const input = document.getElementById('messaging-input');
        const sendBtn = document.getElementById('send-btn');
        
        if (input) {
          // Enter to send (Shift+Enter for new line)
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          });
          
          // Auto-resize textarea
          input.addEventListener('input', () => {
            this.autoResizeTextarea();
          });
          
          // Focus input on page load
          setTimeout(() => input.focus(), 500);
        }
      }
      
      autoResizeTextarea() {
        const input = document.getElementById('messaging-input');
        if (input) {
          input.style.height = 'auto';
          input.style.height = Math.min(input.scrollHeight, 120) + 'px';
        }
      }
      
      async notifyAdmin() {
        try {
          // Get user info
          const sharedAuth = window.sharedAuth;
          const currentUser = sharedAuth ? sharedAuth.getCurrentUser() : null;
          const userName = currentUser && currentUser.username !== 'Anonymous' ? currentUser.username : 'Anonymous User';
          const userEmail = currentUser && currentUser.email ? currentUser.email : 'No email provided';
          
          // Send notification email
          const formData = new FormData();
          formData.append('_replyto', 'griffin@crowhurst.ws');
          formData.append('name', 'CustomPC Live Chat System');
          formData.append('message', `LIVE CHAT REQUEST

User: ${userName}
Email: ${userEmail}
Time: ${new Date().toLocaleString()}
Chat ID: ${this.currentChatId}
Page: ${window.location.href}

A user has opened the live chat and is waiting for assistance. Please log into the CustomPC admin messaging system to respond.

Direct link: ${window.location.origin}/messaging.html

This is an automated notification from the CustomPC.tech live messaging system.`);
          
          await fetch('https://formspree.io/f/xrblokly', {
            method: 'POST',
            headers: { 'Accept': 'application/json' },
            body: formData
          });
          
          console.log('Admin notification sent successfully');
          
          // Update status
          setTimeout(() => {
            this.updateStatus('Admin notified - joining chat soon...');
          }, 2000);
          
        } catch (error) {
          console.error('Failed to notify admin:', error);
          this.updateStatus('Connection established - ready to chat');
        }
      }
      
      updateConnectionStatus() {
        const statusEl = document.getElementById('connection-status');
        if (statusEl) {
          statusEl.textContent = 'Connected';
          statusEl.style.color = '#00ff88';
        }
      }
      
      updateStatus(message) {
        const statusEl = document.getElementById('status-text');
        if (statusEl) {
          statusEl.textContent = message;
        }
      }
      
      addMessage(content, type = 'user', showTime = true) {
        const chat = document.getElementById('messaging-chat');
        if (!chat) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        const time = showTime ? `<div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>` : '';
        
        messageDiv.innerHTML = `
          <div class="message-content">${content}${time}</div>
        `;
        
        chat.appendChild(messageDiv);
        chat.scrollTop = chat.scrollHeight;
        
        // Update message count
        if (type === 'user' || type === 'admin') {
          this.messageCount++;
          this.updateMessageCount();
        }
        
        // Add smooth scroll animation
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(20px)';
        setTimeout(() => {
          messageDiv.style.transition = 'all 0.3s ease';
          messageDiv.style.opacity = '1';
          messageDiv.style.transform = 'translateY(0)';
        }, 10);
      }
      
      async saveMessageToSession(content, type) {
        if (!this.currentChatId) return;
        
        const sharedAuth = window.sharedAuth;
        const currentUser = sharedAuth ? sharedAuth.getCurrentUser() : null;
        const userId = currentUser ? currentUser.username : 'Anonymous User';
        
        const messageData = {
          content: content,
          type: type,
          userId: userId,
          timestamp: new Date().toISOString()
        };
        
        // Send message through Firebase
        await window.firebaseChatManager.sendMessage(this.currentChatId, messageData);
        
        // Refresh admin chat list if admin
        if (this.isAdmin) {
          setTimeout(() => this.loadActiveChats(), 100);
        }
      }
      
      updateSessionInfo() {
        // Update user info if available
        const sharedAuth = window.sharedAuth;
        const currentUser = sharedAuth ? sharedAuth.getCurrentUser() : null;
        
        if (currentUser && currentUser.username !== 'Anonymous') {
          const contactAvatar = document.getElementById('contact-avatar');
          const contactName = document.getElementById('contact-name');
          
          if (contactAvatar && contactName) {
            contactAvatar.textContent = currentUser.username.substring(0, 2).toUpperCase();
            contactName.textContent = `Chat with ${currentUser.username}`;
          }
        }
      }
      
      updateMessageCount() {
        const messageCountEl = document.getElementById('message-count');
        if (messageCountEl) {
          messageCountEl.textContent = this.messageCount;
        }
      }
      
      startSessionTimer() {
        setInterval(() => {
          const now = new Date();
          const diff = now - this.sessionStartTime;
          const minutes = Math.floor(diff / 60000);
          const seconds = Math.floor((diff % 60000) / 1000);
          
          const sessionTimeEl = document.getElementById('session-time');
          if (sessionTimeEl) {
            if (minutes === 0) {
              sessionTimeEl.textContent = `Started ${seconds}s ago`;
            } else if (minutes < 60) {
              sessionTimeEl.textContent = `Started ${minutes}m ${seconds}s ago`;
            } else {
              const hours = Math.floor(minutes / 60);
              const remainingMinutes = minutes % 60;
              sessionTimeEl.textContent = `Started ${hours}h ${remainingMinutes}m ago`;
            }
          }
        }, 1000);
      }
      
      // Admin-specific methods
      setupAdminInterface() {
        this.loadActiveChats();
        this.startChatPolling();
        
        // Update contact info for admin view
        const contactName = document.getElementById('contact-name');
        const contactStatus = document.getElementById('contact-status');
        
        if (contactName) {
          contactName.textContent = 'Admin Chat Management';
        }
        
        if (contactStatus) {
          contactStatus.innerHTML = '<div class="status-indicator"></div><span>Admin Mode - Managing Chats</span>';
        }
      }
      
      async initializeChatSession() {
        if (!this.isAdmin) {
          // Create a new chat session for regular users
          const sharedAuth = window.sharedAuth;
          const currentUser = sharedAuth ? sharedAuth.getCurrentUser() : null;
          const userName = currentUser && currentUser.username !== 'Anonymous' ? currentUser.username : 'Anonymous User';
          const userEmail = currentUser && currentUser.email ? currentUser.email : 'No email provided';
          
          const chatData = {
            userName: userName,
            userEmail: userEmail,
            startTime: new Date().toISOString(),
            messages: [],
            unreadCount: 0
          };
          
          // Use Firebase to create chat session
          this.currentChatId = await window.firebaseChatManager.createChatSession(chatData);
          
          // Start listening for messages in this chat
          this.startMessageListener();
        }
      }
      
      startMessageListener() {
        if (this.currentChatId) {
          window.firebaseChatManager.listenForMessages(this.currentChatId, (message) => {
            // Only display messages that aren't from the current user
            const sharedAuth = window.sharedAuth;
            const currentUser = sharedAuth ? sharedAuth.getCurrentUser() : null;
            const isCurrentUser = message.userId === (currentUser ? currentUser.username : 'Anonymous User');
            
            if (!isCurrentUser) {
              this.displayMessage(message.content, message.type, message.timestamp);
            }
          });
        }
      }
      
      saveChatSession(chatSession) {
        try {
          const existingChats = this.getStoredChats();
          const chatIndex = existingChats.findIndex(chat => chat.id === chatSession.id);
          
          if (chatIndex > -1) {
            existingChats[chatIndex] = chatSession;
          } else {
            existingChats.push(chatSession);
          }
          
          // Keep only last 50 chats
          if (existingChats.length > 50) {
            existingChats.splice(0, existingChats.length - 50);
          }
          
          localStorage.setItem('custompc_chat_sessions', JSON.stringify(existingChats));
        } catch (error) {
          console.error('Failed to save chat session:', error);
        }
      }
      
      getStoredChats() {
        try {
          const stored = localStorage.getItem('custompc_chat_sessions');
          return stored ? JSON.parse(stored) : [];
        } catch (error) {
          console.error('Failed to retrieve stored chats:', error);
          return [];
        }
      }
      
      async loadActiveChats() {
        try {
          const activeChats = await window.firebaseChatManager.getActiveChats();
          this.displayChats(activeChats);
        } catch (error) {
          console.error('Failed to load active chats:', error);
          // Fallback to local storage
          const chats = this.getStoredChats();
          const activeChats = chats.filter(chat => {
            const lastActivity = new Date(chat.lastActivity);
            const now = new Date();
            const hoursSinceActivity = (now - lastActivity) / (1000 * 60 * 60);
            return hoursSinceActivity < 24;
          });
          this.displayChats(activeChats);
        }
      }
      
      displayChats(chats) {
        const chatList = document.getElementById('chat-list');
        const emptyChats = document.getElementById('empty-chats');
        
        if (!chatList) return;
        
        if (chats.length === 0) {
          emptyChats.style.display = 'block';
          return;
        }
        
        emptyChats.style.display = 'none';
        
        // Clear existing chats except empty state
        const existingChats = chatList.querySelectorAll('.chat-item');
        existingChats.forEach(chat => chat.remove());
        
        chats.forEach(chat => {
          const chatElement = this.createChatElement(chat);
          chatList.appendChild(chatElement);
        });
      }
      
      createChatElement(chat) {
        const chatElement = document.createElement('div');
        chatElement.className = 'chat-item';
        chatElement.dataset.chatId = chat.id;
        
        if (chat.unreadCount > 0) {
          chatElement.classList.add('unread');
        }
        
        if (chat.id === this.currentChatId) {
          chatElement.classList.add('active');
        }
        
        const lastMessage = chat.messages && chat.messages.length > 0 ? 
          chat.messages[chat.messages.length - 1] : null;
        
        const preview = lastMessage ? 
          (lastMessage.content.length > 30 ? lastMessage.content.substring(0, 30) + '...' : lastMessage.content) :
          'No messages yet';
        
        const timeAgo = this.formatTimeAgo(new Date(chat.lastActivity));
        const initials = chat.userName.substring(0, 2).toUpperCase();
        
        chatElement.innerHTML = `
          <div class="chat-avatar">${initials}</div>
          <div class="chat-info">
            <div class="chat-name">${chat.userName}</div>
            <div class="chat-preview">${preview}</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">${timeAgo}</div>
            ${chat.unreadCount > 0 ? `<div class="unread-badge">${chat.unreadCount}</div>` : ''}
          </div>
        `;
        
        chatElement.addEventListener('click', () => {
          this.openChat(chat.id);
        });
        
        return chatElement;
      }
      
      formatTimeAgo(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'now';
        if (minutes < 60) return `${minutes}m`;
        if (hours < 24) return `${hours}h`;
        return `${days}d`;
      }
      
      openChat(chatId) {
        this.currentChatId = chatId;
        
        // Update active chat styling
        const chatItems = document.querySelectorAll('.chat-item');
        chatItems.forEach(item => {
          item.classList.remove('active');
          if (item.dataset.chatId === chatId) {
            item.classList.add('active');
            item.classList.remove('unread');
          }
        });
        
        // Load chat messages
        this.loadChatMessages(chatId);
        
        // Mark as read
        this.markChatAsRead(chatId);
      }
      
      async loadChatMessages(chatId) {
        try {
          const messages = await window.firebaseChatManager.getChatMessages(chatId);
          
          // Get chat info for contact display
          const activeChats = await window.firebaseChatManager.getActiveChats();
          const chat = activeChats.find(c => c.id === chatId);
          
          if (chat) {
            // Update contact info
            const contactName = document.getElementById('contact-name');
            const contactAvatar = document.getElementById('contact-avatar');
            
            if (contactName) {
              contactName.textContent = `Chat with ${chat.userName}`;
            }
            
            if (contactAvatar) {
              contactAvatar.textContent = chat.userName.substring(0, 2).toUpperCase();
            }
          }
          
          // Clear and load messages
          const chatContainer = document.getElementById('messaging-chat');
          if (chatContainer) {
            chatContainer.innerHTML = '';
            
            if (messages && messages.length > 0) {
              messages.forEach(message => {
                this.displayMessage(message.content, message.type, message.timestamp);
              });
            } else {
              this.displayMessage('Chat session started. Waiting for user message...', 'system', false);
            }
          }
          
          // Start listening for new messages in this chat
          window.firebaseChatManager.listenForMessages(chatId, (message) => {
            this.displayMessage(message.content, message.type, message.timestamp);
          });
          
        } catch (error) {
          console.error('Failed to load chat messages:', error);
          // Fallback to localStorage method
          const chats = this.getStoredChats();
          const chat = chats.find(c => c.id === chatId);
          
          if (chat) {
            const contactName = document.getElementById('contact-name');
            const contactAvatar = document.getElementById('contact-avatar');
            
            if (contactName) {
              contactName.textContent = `Chat with ${chat.userName}`;
            }
            
            if (contactAvatar) {
              contactAvatar.textContent = chat.userName.substring(0, 2).toUpperCase();
            }
            
            const chatContainer = document.getElementById('messaging-chat');
            if (chatContainer) {
              chatContainer.innerHTML = '';
              
              if (chat.messages && chat.messages.length > 0) {
                chat.messages.forEach(message => {
                  this.displayMessage(message.content, message.type, message.timestamp);
                });
              } else {
                this.displayMessage('Chat session started. Waiting for user message...', 'system', false);
              }
            }
          }
        }
      }
      
      displayMessage(content, type, timestamp) {
        const chat = document.getElementById('messaging-chat');
        if (!chat) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        const time = timestamp ? `<div class="message-time">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>` : '';
        
        messageDiv.innerHTML = `
          <div class="message-content">${content}${time}</div>
        `;
        
        chat.appendChild(messageDiv);
        chat.scrollTop = chat.scrollHeight;
      }
      
      markChatAsRead(chatId) {
        const chats = this.getStoredChats();
        const chat = chats.find(c => c.id === chatId);
        
        if (chat) {
          chat.unreadCount = 0;
          this.saveChatSession(chat);
        }
      }
      
      startChatPolling() {
        if (this.isAdmin) {
          // Listen for new chats in real-time
          window.firebaseChatManager.listenForNewChats((chat) => {
            this.loadActiveChats(); // Refresh the chat list when new chats arrive
          });
          
          // Also poll every 10 seconds as backup
          setInterval(() => {
            this.loadActiveChats();
          }, 10000);
        }
      }
      
      showTypingIndicator() {
        if (this.isTyping) return;
        
        const chat = document.getElementById('messaging-chat');
        if (!chat) return;
        
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
          Admin is typing
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        `;
        
        chat.appendChild(typingDiv);
        chat.scrollTop = chat.scrollHeight;
        this.isTyping = true;
      }
      
      hideTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
          typingIndicator.remove();
          this.isTyping = false;
        }
      }
    }
    
    // Global functions
    function sendMessage() {
      const input = document.getElementById('messaging-input');
      const sendBtn = document.getElementById('send-btn');
      
      if (!input || !input.value.trim()) return;
      
      const message = input.value.trim();
      input.value = '';
      
      // Reset textarea height
      input.style.height = 'auto';
      
      // Disable send button temporarily
      sendBtn.disabled = true;
      setTimeout(() => sendBtn.disabled = false, 1000);
      
      // Add message to chat
      if (window.liveMessaging) {
        const messageType = window.liveMessaging.isAdmin ? 'admin' : 'user';
        window.liveMessaging.addMessage(message, messageType);
        
        // Save message to chat session
        window.liveMessaging.saveMessageToSession(message, messageType);
        
        if (!window.liveMessaging.isAdmin) {
          // Simulate admin response for regular users
          setTimeout(() => {
            window.liveMessaging.showTypingIndicator();
          }, 1000);
          
          setTimeout(() => {
            window.liveMessaging.hideTypingIndicator();
            const response = "Thanks for your message! An admin will respond shortly. You can also email us directly at griffin@crowhurst.ws for immediate assistance.";
            window.liveMessaging.addMessage(response, 'system', false);
            window.liveMessaging.saveMessageToSession(response, 'system');
          }, 3000);
        }
      }
      
      // Focus back to input
      input.focus();
    }
    
    // Admin functions
    function refreshChats() {
      if (window.liveMessaging && window.liveMessaging.isAdmin) {
        window.liveMessaging.loadActiveChats();
      }
    }
    
    function markAllAsRead() {
      if (window.liveMessaging && window.liveMessaging.isAdmin) {
        const chats = window.liveMessaging.getStoredChats();
        chats.forEach(chat => {
          chat.unreadCount = 0;
          window.liveMessaging.saveChatSession(chat);
        });
        window.liveMessaging.loadActiveChats();
      }
    }
    
    function startQuickChat(type) {
      const templates = {
        support: "Hi! I need technical support with my PC. Here's what's happening: [Please describe your issue]",
        quote: "Hi! I'd like to get a quote for a custom PC build. My requirements are: [Please describe what you need]",
        general: "Hi! I have a question about: [Please describe your question]"
      };
      
      const input = document.getElementById('messaging-input');
      if (input && templates[type]) {
        input.value = templates[type];
        input.focus();
        
        // Position cursor at the placeholder
        const placeholderStart = input.value.indexOf('[');
        if (placeholderStart !== -1) {
          input.setSelectionRange(placeholderStart, input.value.indexOf(']') + 1);
        }
        
        // Auto-resize
        if (window.liveMessaging) {
          window.liveMessaging.autoResizeTextarea();
        }
      }
    }
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      window.liveMessaging = new LiveMessagingPage();
    });
  </script>
</body>
</html>
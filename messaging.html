<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Messaging | CustomPC.tech</title>
  <meta name="description" content="Live messaging with CustomPC.tech support team. Get real-time help with your custom PC build questions and technical support." />
  <meta name="keywords" content="live chat, custompc support, pc help, technical support, messaging" />
  <meta name="author" content="CustomPC.tech" />
  <meta property="og:title" content="Live Messaging | CustomPC.tech" />
  <meta property="og:description" content="Chat with our PC experts in real-time for instant help and support." />
  <meta property="og:url" content="https://custompc.tech/messaging.html" />
  <link rel="canonical" href="https://custompc.tech/messaging.html" />
  <link rel="icon" type="image/png" sizes="32x32" href="images/logo.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="images/logo.png" />
  <link rel="shortcut icon" href="images/logo.png" />
  <link rel="apple-touch-icon" href="images/logo.png" />
  
  <!-- Shared Navbar Styles -->
  <link rel="stylesheet" href="frontend/navbar.css" />
  
  <style>
    :root{
      --space:10px; --space-sm:6px; --space-lg:16px;
      --bg:#0a0f1a; --ink:#e9eefc; --muted:#aeb9d4;
      --panel:#111729; --panel2:#0d1426; --border:rgba(255,255,255,.08);
      --accent1:#7db2ff; --accent2:#7cf2e6;
      --radius:18px; --shadow:0 20px 40px rgba(0,0,0,.35);
      --max:1200px;
    }
    *{box-sizing:border-box}
    html{scrollbar-gutter:stable}
    body{
      margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial;color:var(--ink);
      background:radial-gradient(1200px 600px at 50% -10%, #0f162b 8%, transparent 55%), linear-gradient(#081021, #0a0f1a 40%, #0a0f1a);
      line-height:1.55;overflow-x:hidden;min-height:100vh;
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:var(--space-lg);width:100%;box-sizing:border-box}

    /* Header (shared) */
    header{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:var(--space-lg);padding:0 var(--space);
      max-width:var(--max);margin-left:auto;margin-right:auto;width:100%
    }
    .brand a{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;font-weight:700;letter-spacing:.3px;white-space:nowrap}
    nav{display:flex;gap:var(--space);flex-wrap:wrap}
    .pill{display:inline-block;padding:10px 14px;border-radius:999px;color:var(--ink);text-decoration:none;border:1px solid transparent}
    .pill:hover{background:#0f1830}
    .pill.active{background:linear-gradient(120deg,rgba(125,178,255,.15),rgba(124,242,230,.15));border-color:rgba(255,255,255,.08)}

    /* Messaging Interface */
    .messaging-container {
      display: flex;
      height: calc(100vh - 200px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    /* Chat Area (Left Side) */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
    }
    
    /* Contact Sidebar (Right Side) */
    .contact-sidebar {
      width: 300px;
      background: var(--panel2);
      display: flex;
      flex-direction: column;
    }
    
    .messaging-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(125,178,255,.1), rgba(124,242,230,.1));
    }
    
    /* Contact Info Header */
    .contact-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }
    
    .contact-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7db2ff, #7cf2e6);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 24px;
      font-weight: 600;
      color: #0b0f1a;
    }
    
    .contact-name {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 4px;
    }
    
    .contact-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 14px;
      color: var(--muted);
    }
    
    .contact-status.online {
      color: #00ff88;
    }
    
    /* Contact Details */
    .contact-details {
      padding: 20px;
      flex: 1;
    }
    
    .detail-section {
      margin-bottom: 24px;
    }
    
    .detail-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      font-size: 14px;
    }
    
    .detail-icon {
      width: 16px;
      text-align: center;
      color: var(--accent1);
    }
    
    .quick-actions-sidebar {
      padding: 20px;
      border-top: 1px solid var(--border);
    }
    
    .quick-action-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--ink);
      text-decoration: none;
      text-align: center;
      margin-bottom: 8px;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .quick-action-btn:hover {
      background: rgba(125, 178, 255, 0.1);
      border-color: rgba(125, 178, 255, 0.3);
    }
    
    /* Admin Chat Management */
    .admin-chat-sidebar {
      width: 300px;
      background: var(--panel2);
      border-right: 1px solid var(--border);
      display: none;
      flex-direction: column;
    }
    
    .admin-sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(125,178,255,.1), rgba(124,242,230,.1));
    }
    
    .admin-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    .admin-subtitle {
      font-size: 14px;
      color: var(--muted);
    }
    
    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    
    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .chat-item:hover {
      background: rgba(125, 178, 255, 0.1);
      border-color: rgba(125, 178, 255, 0.2);
    }
    
    .chat-item.active {
      background: rgba(125, 178, 255, 0.15);
      border-color: rgba(125, 178, 255, 0.3);
    }
    
    .chat-item.unread {
      background: rgba(255, 99, 132, 0.1);
      border-color: rgba(255, 99, 132, 0.2);
    }
    
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7db2ff, #7cf2e6);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 14px;
      font-weight: 600;
      color: #0b0f1a;
      flex-shrink: 0;
    }
    
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    
    .chat-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-preview {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    
    .chat-time {
      font-size: 11px;
      color: var(--muted);
    }
    
    .unread-badge {
      background: #ff6b6b;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }
    
    .admin-actions {
      padding: 16px;
      border-top: 1px solid var(--border);
    }
    
    /* Status message animations */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    .admin-btn {
      display: block;
      width: 100%;
      padding: 8px 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--ink);
      text-decoration: none;
      text-align: center;
      margin-bottom: 8px;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .admin-btn:hover {
      background: rgba(125, 178, 255, 0.1);
      border-color: rgba(125, 178, 255, 0.3);
    }
    
    .admin-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* Chat History Styles */
    .chat-history-container {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .chat-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      background: var(--panel2);
    }

    .chat-history-header h3 {
      margin: 0;
      color: var(--ink);
      font-size: 16px;
    }

    .btn-new-chat {
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: var(--bg);
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .btn-new-chat:hover {
      transform: translateY(-1px);
    }

    .chat-history-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .chat-history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.2s;
      cursor: pointer;
    }

    .chat-history-item:hover {
      background: rgba(125, 178, 255, 0.05);
    }

    .chat-history-item.active {
      background: rgba(125, 178, 255, 0.1);
      border-left: 3px solid var(--accent1);
    }

    .chat-history-item:last-child {
      border-bottom: none;
    }

    .chat-item-info {
      flex: 1;
    }

    .chat-item-title {
      color: var(--ink);
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .chat-item-time {
      color: var(--muted);
      font-size: 12px;
    }

    .chat-item-actions {
      display: flex;
      gap: 8px;
    }

    .btn-load-chat {
      background: var(--accent1);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-load-chat:hover {
      background: #5a9cff;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .chat-history-header {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }

      .chat-history-item {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .chat-item-actions {
        justify-content: flex-end;
      }
    }
    
    .admin-btn.primary {
      background: linear-gradient(135deg, #7db2ff, #7cf2e6);
      color: #0b0f1a;
      border: none;
    }
    
    .empty-chats {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    
    .empty-chats-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    /* Admin layout adjustments */
    .messaging-container.admin-mode {
      display: flex;
    }
    
    .messaging-container.admin-mode .admin-chat-sidebar {
      display: flex;
    }
    
    .messaging-title {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 20px;
    }
    
    .live-indicator {
      width: 12px;
      height: 12px;
      background: #00ff88;
      border-radius: 50%;
      margin-right: 12px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .messaging-status {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: var(--panel2);
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      color: var(--muted);
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      background: #00ff88;
      animation: pulse 2s infinite;
    }
    
    .messaging-chat {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .message {
      display: flex;
      margin-bottom: 16px;
    }
    
    .message.user {
      justify-content: flex-end;
    }
    
    .message.admin {
      justify-content: flex-start;
    }
    
    .message.system {
      justify-content: center;
    }
    
    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    
    .message.system .message-content {
      background: rgba(125, 178, 255, 0.1);
      border: 1px solid rgba(125, 178, 255, 0.2);
      color: var(--ink);
      text-align: center;
      max-width: 90%;
    }
    
    .message.user .message-content {
      background: linear-gradient(135deg, #7db2ff, #7cf2e6);
      color: #0b0f1a;
      font-weight: 500;
    }
    
    .message.admin .message-content {
      background: var(--panel2);
      border: 1px solid var(--border);
      color: var(--ink);
    }
    
    .message-time {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      text-align: right;
    }
    
    .message.admin .message-time {
      text-align: left;
    }
    
    .messaging-input-container {
      display: flex;
      padding: 20px;
      border-top: 1px solid var(--border);
      gap: 12px;
      background: var(--panel);
      position: sticky;
      bottom: 0;
      z-index: 100;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .messaging-input {
      flex: 1;
      padding: 16px 20px;
      border: 2px solid var(--border);
      border-radius: 25px;
      background: var(--panel2);
      color: var(--ink);
      outline: none;
      font-size: 15px;
      resize: none;
      min-height: 50px;
      max-height: 120px;
      font-family: inherit;
      line-height: 1.4;
      transition: all 0.3s ease;
    }
    
    .messaging-input:focus {
      border-color: var(--accent1);
      box-shadow: 0 0 0 3px rgba(125, 178, 255, 0.2);
      background: rgba(255, 255, 255, 0.02);
      animation: inputFocus 0.3s ease;
    }
    
    .messaging-input::placeholder {
      color: var(--muted);
      opacity: 0.8;
    }
    
    @keyframes inputFocus {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    .send-btn {
      padding: 16px 24px;
      background: linear-gradient(135deg, #7db2ff, #7cf2e6);
      color: #0b0f1a;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 50px;
      font-size: 15px;
    }
    
    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(125, 178, 255, 0.4);
    }
    
    .send-icon {
      font-size: 16px;
      transition: transform 0.2s ease;
    }
    
    .send-btn:hover .send-icon {
      transform: translateX(2px);
    }
    
    .send-btn:active {
      transform: translateY(0);
    }
    
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Welcome Section */
    .welcome-section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .welcome-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    .welcome-subtitle {
      color: var(--muted);
      margin-bottom: 16px;
    }
    
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    
    .quick-action {
      padding: 12px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
    }
    
    .quick-action:hover {
      background: rgba(125, 178, 255, 0.1);
      border-color: rgba(125, 178, 255, 0.3);
    }
    
    .quick-action-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .quick-action-desc {
      font-size: 13px;
      color: var(--muted);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .messaging-container {
        height: calc(100vh - 160px);
        flex-direction: column;
      }
      
      .contact-sidebar {
        width: 100%;
        height: 200px;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      
      .chat-area {
        border-right: none;
      }
      
      .messaging-input-container {
        padding: 16px;
      }
      
      .message-content {
        max-width: 85%;
      }
      
      .quick-actions {
        grid-template-columns: 1fr;
      }
      
      .contact-details {
        padding: 12px;
      }
      
      .detail-section {
        margin-bottom: 16px;
      }
    }
    
    /* Typing indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      color: var(--muted);
      font-size: 13px;
      font-style: italic;
    }
    
    .typing-dots {
      display: inline-flex;
      margin-left: 8px;
    }
    
    .typing-dots span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--muted);
      margin: 0 1px;
      animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <!-- Header is now dynamically generated by navbar.js -->

    <!-- Welcome Section -->
    <section class="welcome-section">
      <div class="welcome-title">
        <div class="live-indicator"></div>
        Live Messaging
      </div>
      <p class="welcome-subtitle">Chat with our PC experts in real-time for instant help and support</p>
      
      <div class="quick-actions">
        <div class="quick-action" onclick="startQuickChat('support')">
          <div class="quick-action-title">Technical Support</div>
          <div class="quick-action-desc">Get help with PC issues or questions</div>
        </div>
        
        <div class="quick-action" onclick="startQuickChat('quote')">
          <div class="quick-action-title">Get a Quote</div>
          <div class="quick-action-desc">Pricing for custom build projects</div>
        </div>
        
        <div class="quick-action" onclick="startQuickChat('general')">
          <div class="quick-action-title">General Question</div>
          <div class="quick-action-desc">Other inquiries and information</div>
        </div>
      </div>
    </section>

    <!-- Main Messaging Interface -->
    <div class="messaging-container" id="messaging-container">
      <!-- Admin Chat Sidebar (Left Side - Only for Admins) -->
      <div class="admin-chat-sidebar" id="admin-chat-sidebar">
        <div class="admin-sidebar-header">
          <div class="admin-title">Active Chats</div>
          <div class="admin-subtitle">Manage customer conversations</div>
        </div>
        
        <div class="chat-list" id="chat-list">
          <div class="empty-chats" id="empty-chats">
            <div class="empty-chats-icon">üí¨</div>
            <div>No active chats</div>
            <div style="font-size: 12px; margin-top: 8px;">Conversations will appear here when users start chatting</div>
          </div>
        </div>
        
        <div class="admin-actions">
          <button class="admin-btn primary" onclick="refreshChats()">Refresh Chats</button>
          <button class="admin-btn" onclick="markAllAsRead()">Mark All Read</button>
          <a href="payments.html" class="admin-btn">Payment System</a>
        </div>
      </div>
      
      <!-- Chat Area (Middle/Right Side) -->
      <div class="chat-area">
        <div class="messaging-header">
          <div class="messaging-title">
            <div class="live-indicator"></div>
            Live Chat Support
          </div>
          <div style="font-size: 14px; color: var(--muted);">
            <span id="connection-status">Connecting...</span>
          </div>
        </div>
        
        <div class="messaging-status">
          <div class="status-indicator"></div>
          <span id="status-text">Notifying our team to join the chat...</span>
        </div>
        
        <div class="messaging-chat" id="messaging-chat">
          <div class="message system">
            <div class="message-content">
              üí¨ Chat system ready! Type a message below to get started.
            </div>
          </div>
        </div>
        
        <div class="messaging-input-container" id="fallback-input">
          <textarea 
            id="messaging-input" 
            class="messaging-input" 
            placeholder="Type your message here... (Press Enter to send)"
            rows="1"
          ></textarea>
          <button id="send-btn" class="send-btn" onclick="sendMessage()">
            <span>Send</span>
            <span class="send-icon">üì§</span>
          </button>
          <button onclick="testMessage()" style="margin-left: 10px; padding: 16px; background: #ff6b6b; color: white; border: none; border-radius: 8px; cursor: pointer;">
            üß™ Test
          </button>
        </div>
      </div>
      
      <!-- Contact Sidebar (Right Side) -->
      <div class="contact-sidebar">
        <div class="contact-header">
          <div class="contact-avatar" id="contact-avatar">
            PC
          </div>
          <div class="contact-name" id="contact-name">CustomPC.tech Support</div>
          <div class="contact-status online" id="contact-status">
            <div class="status-indicator"></div>
            <span>Online - Ready to help</span>
          </div>
        </div>
        
        <div class="contact-details">
          <div class="detail-section">
            <div class="detail-title">Contact Information</div>
            <div class="detail-item">
              <div class="detail-icon"></div>
              <div>griffin@crowhurst.ws</div>
            </div>
            <div class="detail-item">
              <div class="detail-icon"></div>
              <div>CustomPC.tech</div>
            </div>
            <div class="detail-item">
              <div class="detail-icon"></div>
              <div>Response time: ~5 minutes</div>
            </div>
          </div>
          
          <div class="detail-section">
            <div class="detail-title">Session Info</div>
            <div class="detail-item">
              <div class="detail-icon"></div>
              <div id="session-time">Started just now</div>
            </div>
            <div class="detail-item">
              <div class="detail-icon"></div>
              <div><span id="message-count">1</span> messages</div>
            </div>
          </div>
        </div>
        
        <div class="quick-actions-sidebar">
          <div class="detail-title">Quick Actions</div>
          <a href="#" class="quick-action-btn" onclick="startQuickChat('support')">Technical Support</a>
          <a href="#" class="quick-action-btn" onclick="startQuickChat('quote')">Get Quote</a>
          <a href="#" class="quick-action-btn" onclick="startQuickChat('general')">General Question</a>
          <a href="contact.html" class="quick-action-btn">Email Instead</a>
        </div>
      </div>
    </div>
  </div>

  <script src="frontend/shared-auth.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <!-- Firebase Chat Manager -->
  <script src="config/firebase-config.js"></script>
  <script src="frontend/navbar.js"></script>
  
  <!-- Kiro Update Notification System -->
  <div id="kiro-notification" style="
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    font-family: system-ui, sans-serif;
    font-size: 14px;
    font-weight: 500;
    display: none;
    max-width: 300px;
    animation: slideInRight 0.3s ease-out;
  ">
    <div id="kiro-message">ü§ñ Kiro update applied</div>
    <button onclick="this.parentElement.style.display='none'" style="
      position: absolute;
      top: 4px;
      right: 8px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.7;
    ">√ó</button>
  </div>

  <style>
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>

  <script>
    function showKiroNotification(message, duration = 5000) {
      const notification = document.getElementById('kiro-notification');
      const messageDiv = document.getElementById('kiro-message');
      
      messageDiv.textContent = message;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
          notification.style.display = 'none';
          notification.style.animation = 'slideInRight 0.3s ease-out';
        }, 300);
      }, duration);
    }

    window.addEventListener('load', function() {
      setTimeout(() => {
        showKiroNotification('üí¨ Messages + Payments in dropdown, Login/Signup in navbar!');
      }, 1000);
    });
  </script>

  <!-- Crisp Chat Integration - Disabled on messaging page to use custom chat -->
  <script type="text/javascript">
    console.log('Crisp chat disabled on messaging page - using custom chat interface');
  </script>
  
  <script>
    // Handle Tawk.to events
    Tawk_API.onLoad = function(){
      console.log('Tawk.to chat loaded successfully');
      
      // Update status
      const statusText = document.getElementById('status-text');
      if (statusText) {
        statusText.textContent = 'Live chat ready - Our team is here to help';
      }
      
      // Update connection status
      const connectionStatus = document.getElementById('connection-status');
      if (connectionStatus) {
        connectionStatus.textContent = 'Connected';
        connectionStatus.style.color = '#00ff88';
      }
      
      // Create or get chat session for Firebase
      if (window.liveMessaging && !window.liveMessaging.isAdmin) {
        window.liveMessaging.initializeChatSession();
      }
    };
    
    Tawk_API.onChatStarted = function(){
      console.log('Chat session started');
      
      // Update status
      const statusText = document.getElementById('status-text');
      if (statusText) {
        statusText.textContent = 'Chat active - Our team is here to help';
      }
      
      // Initialize chat session when Tawk.to chat starts
      if (window.liveMessaging && !window.liveMessaging.isAdmin) {
        window.liveMessaging.initializeChatSession();
      }
    };
    
    Tawk_API.onAgentJoinChat = function(data){
      console.log('Agent joined chat:', data);
      
      // Update contact info with agent details
      const contactName = document.getElementById('contact-name');
      const contactAvatar = document.getElementById('contact-avatar');
      
      if (contactName && data.name) {
        contactName.textContent = data.name;
      }
      
      if (contactAvatar && data.name) {
        contactAvatar.textContent = data.name.substring(0, 2).toUpperCase();
      }
      
      // Update status
      const statusText = document.getElementById('status-text');
      if (statusText) {
        statusText.textContent = `${data.name || 'Support agent'} has joined the chat`;
      }
    };
    
    // Capture visitor messages and save to Firebase
    Tawk_API.onChatMessageVisitor = function(message){
      console.log('Visitor message:', message);
      
      // Save message to Firebase for admin visibility
      if (window.liveMessaging) {
        // Ensure we have a chat session first
        if (!window.liveMessaging.currentChatId) {
          window.liveMessaging.initializeChatSession();
        }
        
        // Save message after a short delay to ensure chat session is created
        setTimeout(() => {
          if (window.liveMessaging && window.liveMessaging.currentChatId) {
            const messageData = {
              content: message.message,
              type: 'user',
              userId: 'Tawk.to Visitor',
              timestamp: new Date().toISOString()
            };
            
            // Save to Firebase
            if (window.firebaseChatManager) {
              window.firebaseChatManager.sendMessage(window.liveMessaging.currentChatId, messageData).catch(err => {
                console.error('Failed to save visitor message to Firebase:', err);
              });
            }
          }
        }, 500);
      }
      
      // Update message count
      if (window.liveMessaging) {
        window.liveMessaging.messageCount++;
        window.liveMessaging.updateMessageCount();
      }
    };
    
    // Capture agent messages
    Tawk_API.onChatMessageAgent = function(message){
      console.log('Agent message:', message);
      
      // Save agent message to Firebase
      if (window.liveMessaging && window.liveMessaging.currentChatId) {
        const messageData = {
          content: message.message,
          type: 'admin',
          userId: message.sender ? message.sender.name : 'Admin',
          timestamp: new Date().toISOString()
        };
        
        // Save to Firebase
        if (window.firebaseChatManager) {
          window.firebaseChatManager.sendMessage(window.liveMessaging.currentChatId, messageData).catch(err => {
            console.error('Failed to save agent message to Firebase:', err);
          });
        }
      }
      
      // Update message count
      if (window.liveMessaging) {
        window.liveMessaging.messageCount++;
        window.liveMessaging.updateMessageCount();
      }
    };
  </script>
  
  <script>
    class LiveMessagingPage {
      constructor() {
        this.messageQueue = [];
        this.isTyping = false;
        this.messageCount = 1;
        this.sessionStartTime = new Date();
        this.isAdmin = false;
        this.currentChatId = null;
        this.activeChats = new Map();
        this.init();
      }
      
      async init() {
        console.log('üöÄ Initializing LiveMessagingPage');
        
        this.checkAdminStatus();
        console.log('Admin status:', this.isAdmin);
        
        this.setupInputHandlers();
        console.log('‚úÖ Input handlers set up');
        
        // Initialize basic chat interface immediately
        this.initializeBasicChat();
        
        // Load user chat history first
        await this.loadUserChatHistory();
        
        this.initializeChatSession();
        this.updateConnectionStatus();
        this.autoResizeTextarea();
        this.updateSessionInfo();
        this.startSessionTimer();
        
        if (this.isAdmin) {
          this.setupAdminInterface();
        } else {
          this.notifyAdmin();
        }
        
        console.log('‚úÖ LiveMessagingPage initialization complete');
      }
      
      initializeBasicChat() {
        console.log('üîß Initializing basic chat interface');
        
        const chat = document.getElementById('messaging-chat');
        if (!chat) {
          console.error('‚ùå Chat container not found');
          return;
        }
        
        // Clear any existing content
        chat.innerHTML = '';
        
        // Add welcome message
        this.addMessage('Welcome to CustomPC.tech live support!<br><br>Loading secure chat system... Please wait a moment.', 'system', false);
        
        console.log('‚úÖ Basic chat initialized');
      }

      // Load user's previous chat history
      async loadUserChatHistory() {
        try {
          const currentUser = this.getCurrentUser();
          if (!currentUser || !currentUser.username || currentUser.username === 'Anonymous') {
            console.log('No logged-in user, starting fresh chat');
            return;
          }

          console.log('Loading chat history for user:', currentUser.username);
          
          // Get user's chat history from Firebase
          const chatHistory = await window.firebaseChatManager.getUserChatHistory(currentUser.username);
          
          if (chatHistory && chatHistory.length > 0) {
            // Show chat history in UI
            this.displayChatHistory(chatHistory);
            
            // Load the most recent chat if it exists
            const mostRecentChat = chatHistory[0];
            if (mostRecentChat && mostRecentChat.chatId) {
              await this.loadExistingChat(mostRecentChat.chatId);
              showKiroNotification(`üí¨ Loaded ${chatHistory.length} previous chat${chatHistory.length > 1 ? 's' : ''} for ${currentUser.username}`);
            }
          } else {
            console.log('No previous chat history found for user');
            showKiroNotification(`üëã Welcome back ${currentUser.username}! Starting fresh chat.`);
          }
          
        } catch (error) {
          console.error('Error loading user chat history:', error);
          showKiroNotification('‚ö†Ô∏è Could not load chat history, starting fresh');
        }
      }

      // Display chat history in sidebar
      displayChatHistory(chatHistory) {
        const chatHistoryContainer = this.createChatHistoryContainer();
        
        chatHistory.forEach(chat => {
          const chatItem = this.createChatHistoryItem(chat);
          chatHistoryContainer.appendChild(chatItem);
        });
      }

      // Create chat history container
      createChatHistoryContainer() {
        let container = document.getElementById('chat-history-container');
        
        if (!container) {
          container = document.createElement('div');
          container.id = 'chat-history-container';
          container.className = 'chat-history-container';
          container.innerHTML = `
            <div class="chat-history-header">
              <h3>üí¨ Your Chat History</h3>
              <button onclick="window.liveMessaging.startNewChat()" class="btn-new-chat">+ New Chat</button>
            </div>
            <div class="chat-history-list" id="chat-history-list"></div>
          `;
          
          // Insert before the main chat area
          const messagingContainer = document.getElementById('messaging-container');
          messagingContainer.insertBefore(container, messagingContainer.firstChild);
        }
        
        return document.getElementById('chat-history-list');
      }

      // Create individual chat history item
      createChatHistoryItem(chat) {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-history-item';
        chatItem.dataset.chatId = chat.chatId;
        
        const lastActivity = new Date(chat.lastActivity || chat.createdAt);
        const timeAgo = this.getTimeAgo(lastActivity);
        
        chatItem.innerHTML = `
          <div class="chat-item-info">
            <div class="chat-item-title">${chat.title || 'Chat Session'}</div>
            <div class="chat-item-time">${timeAgo}</div>
          </div>
          <div class="chat-item-actions">
            <button onclick="window.liveMessaging.loadExistingChat('${chat.chatId}')" class="btn-load-chat">Load</button>
          </div>
        `;
        
        return chatItem;
      }

      // Load an existing chat
      async loadExistingChat(chatId) {
        try {
          const currentUser = this.getCurrentUser();
          if (!currentUser) {
            console.error('No user logged in');
            return;
          }

          console.log('Loading existing chat:', chatId);
          
          // Get chat messages
          const messages = await window.firebaseChatManager.getUserChatMessages(currentUser.username, chatId);
          
          // Clear current chat
          const chatContainer = document.getElementById('messaging-chat');
          chatContainer.innerHTML = '';
          
          // Set current chat ID
          this.currentChatId = chatId;
          
          // Display all messages
          messages.forEach(message => {
            this.displayMessage(message.content, message.type, message.timestamp);
          });
          
          // Start listening for new messages
          this.startMessageListener();
          
          // Update UI
          this.highlightActiveChat(chatId);
          showKiroNotification(`üìñ Loaded chat with ${messages.length} messages`);
          
        } catch (error) {
          console.error('Error loading existing chat:', error);
          showKiroNotification('‚ùå Failed to load chat');
        }
      }

      // Start a new chat
      startNewChat() {
        // Clear current chat
        const chatContainer = document.getElementById('messaging-chat');
        chatContainer.innerHTML = '';
        
        // Reset chat ID
        this.currentChatId = null;
        
        // Initialize new chat session
        this.initializeChatSession();
        
        // Clear active chat highlight
        this.clearActiveChatHighlight();
        
        showKiroNotification('‚ú® Started new chat session');
      }

      // Highlight active chat in history
      highlightActiveChat(chatId) {
        // Remove previous highlights
        document.querySelectorAll('.chat-history-item').forEach(item => {
          item.classList.remove('active');
        });
        
        // Highlight current chat
        const activeItem = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (activeItem) {
          activeItem.classList.add('active');
        }
      }

      // Clear active chat highlight
      clearActiveChatHighlight() {
        document.querySelectorAll('.chat-history-item').forEach(item => {
          item.classList.remove('active');
        });
      }

      // Get current user helper
      getCurrentUser() {
        if (window.sharedAuth && window.sharedAuth.currentUser) {
          return window.sharedAuth.currentUser;
        }
        
        try {
          const storedUser = localStorage.getItem('currentUser');
          return storedUser ? JSON.parse(storedUser) : null;
        } catch (error) {
          return null;
        }
      }

      // Get time ago helper
      getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
      }
      
      checkAdminStatus() {
        const sharedAuth = window.sharedAuth;
        this.isAdmin = sharedAuth && sharedAuth.isCurrentUserAdmin();
        
        if (this.isAdmin) {
          document.getElementById('messaging-container').classList.add('admin-mode');
          console.log('Admin mode activated');
        }
      }
      
      setupInputHandlers() {
        const input = document.getElementById('messaging-input');
        const sendBtn = document.getElementById('send-btn');
        
        if (input) {
          // Enter to send (Shift+Enter for new line)
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          });
          
          // Auto-resize textarea
          input.addEventListener('input', () => {
            this.autoResizeTextarea();
          });
          
          // Focus input on page load
          setTimeout(() => input.focus(), 500);
        }
      }
      
      autoResizeTextarea() {
        const input = document.getElementById('messaging-input');
        if (input) {
          input.style.height = 'auto';
          input.style.height = Math.min(input.scrollHeight, 120) + 'px';
        }
      }
      
      async notifyAdmin() {
        try {
          // Get user info
          const sharedAuth = window.sharedAuth;
          const currentUser = sharedAuth ? sharedAuth.getCurrentUser() : null;
          const userName = currentUser && currentUser.username !== 'Anonymous' ? currentUser.username : 'Anonymous User';
          const userEmail = currentUser && currentUser.email ? currentUser.email : 'No email provided';
          
          // Send notification email
          const formData = new FormData();
          formData.append('_replyto', 'griffin@crowhurst.ws');
          formData.append('name', 'CustomPC Live Chat System');
          formData.append('message', `LIVE CHAT REQUEST

User: ${userName}
Email: ${userEmail}
Time: ${new Date().toLocaleString()}
Chat ID: ${this.currentChatId}
Page: ${window.location.href}

A user has opened the live chat and is waiting for assistance. Please log into the CustomPC admin messaging system to respond.

Direct link: ${window.location.origin}/messaging.html

This is an automated notification from the CustomPC.tech live messaging system.`);
          
          await fetch('https://formspree.io/f/xrblokly', {
            method: 'POST',
            headers: { 'Accept': 'application/json' },
            body: formData
          });
          
          console.log('Admin notification sent successfully');
          
          // Update status
          setTimeout(() => {
            this.updateStatus('Admin notified - joining chat soon...');
          }, 2000);
          
        } catch (error) {
          console.error('Failed to notify admin:', error);
          this.updateStatus('Connection established - ready to chat');
        }
      }
      
      updateConnectionStatus() {
        const statusEl = document.getElementById('connection-status');
        if (statusEl) {
          statusEl.textContent = 'Connected';
          statusEl.style.color = '#00ff88';
        }
      }
      
      updateStatus(message) {
        const statusEl = document.getElementById('status-text');
        if (statusEl) {
          statusEl.textContent = message;
        }
      }
      
      addMessage(content, type = 'user', showTime = true) {
        console.log('üì® addMessage called:', { content, type, showTime });
        
        const chat = document.getElementById('messaging-chat');
        console.log('Chat element:', chat);
        
        if (!chat) {
          console.error('‚ùå Chat element not found');
          return;
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        const time = showTime ? `<div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>` : '';
        
        messageDiv.innerHTML = `
          <div class="message-content">${content}${time}</div>
        `;
        
        console.log('üí¨ Adding message to chat:', messageDiv);
        chat.appendChild(messageDiv);
        chat.scrollTop = chat.scrollHeight;
        
        // Update message count
        if (type === 'user' || type === 'admin') {
          this.messageCount++;
          this.updateMessageCount();
        }
        
        // Add smooth scroll animation
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(20px)';
        setTimeout(() => {
          messageDiv.style.transition = 'all 0.3s ease';
          messageDiv.style.opacity = '1';
          messageDiv.style.transform = 'translateY(0)';
        }, 10);
      }
      
      async saveMessageToSession(content, type) {
        console.log('üíæ Saving message to session:', { content, type });
        
        const currentUser = this.getCurrentUser();
        const userId = currentUser ? currentUser.username : 'Anonymous User';
        
        const messageData = {
          content: content,
          type: type,
          userId: userId,
          timestamp: new Date().toISOString()
        };
        
        // Save to localStorage as fallback
        try {
          const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
          chatHistory.push(messageData);
          localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
          console.log('‚úÖ Message saved to localStorage');
        } catch (error) {
          console.error('Failed to save to localStorage:', error);
        }
        
        // Send message through Firebase if available
        if (window.firebaseChatManager && this.currentChatId) {
          try {
            await window.firebaseChatManager.sendMessage(this.currentChatId, messageData);
            console.log('‚úÖ Message saved to Firebase');
            
            // Update chat activity for user
            if (currentUser && currentUser.username) {
              await window.firebaseChatManager.updateChatActivity(this.currentChatId, currentUser.username);
            }
            
            // Refresh admin chat list if admin
            if (this.isAdmin) {
              setTimeout(() => this.loadActiveChats(), 100);
            }
          } catch (error) {
            console.error('Failed to save to Firebase:', error);
          }
        } else {
          console.log('Firebase not available, using localStorage only');
        }
      }
      
      updateSessionInfo() {
        // Update user info if available
        const sharedAuth = window.sharedAuth;
        const currentUser = sharedAuth ? sharedAuth.getCurrentUser() : null;
        
        if (currentUser && currentUser.username !== 'Anonymous') {
          const contactAvatar = document.getElementById('contact-avatar');
          const contactName = document.getElementById('contact-name');
          
          if (contactAvatar && contactName) {
            contactAvatar.textContent = currentUser.username.substring(0, 2).toUpperCase();
            contactName.textContent = `Chat with ${currentUser.username}`;
          }
        }
      }
      
      updateMessageCount() {
        const messageCountEl = document.getElementById('message-count');
        if (messageCountEl) {
          messageCountEl.textContent = this.messageCount;
        }
      }
      
      startSessionTimer() {
        setInterval(() => {
          const now = new Date();
          const diff = now - this.sessionStartTime;
          const minutes = Math.floor(diff / 60000);
          const seconds = Math.floor((diff % 60000) / 1000);
          
          const sessionTimeEl = document.getElementById('session-time');
          if (sessionTimeEl) {
            if (minutes === 0) {
              sessionTimeEl.textContent = `Started ${seconds}s ago`;
            } else if (minutes < 60) {
              sessionTimeEl.textContent = `Started ${minutes}m ${seconds}s ago`;
            } else {
              const hours = Math.floor(minutes / 60);
              const remainingMinutes = minutes % 60;
              sessionTimeEl.textContent = `Started ${hours}h ${remainingMinutes}m ago`;
            }
          }
        }, 1000);
      }
      
      // Admin-specific methods
      setupAdminInterface() {
        this.loadActiveChats();
        this.startChatPolling();
        
        // Update contact info for admin view
        const contactName = document.getElementById('contact-name');
        const contactStatus = document.getElementById('contact-status');
        
        if (contactName) {
          contactName.textContent = 'Admin Chat Management';
        }
        
        if (contactStatus) {
          contactStatus.innerHTML = '<div class="status-indicator"></div><span>Admin Mode - Managing Chats</span>';
        }
      }
      
      async initializeChatSession() {
        if (!this.isAdmin) {
          try {
            // Wait for firebaseChatManager to be available
            if (!window.firebaseChatManager) {
              console.log('Waiting for firebaseChatManager to initialize...');
              let attempts = 0;
              while (!window.firebaseChatManager && attempts < 10) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
              }
            }
            
            // Create a new chat session for regular users
            const sharedAuth = window.sharedAuth;
            const currentUser = sharedAuth ? sharedAuth.getCurrentUser() : null;
            const userName = currentUser && currentUser.username !== 'Anonymous' ? currentUser.username : 'Anonymous User';
            const userEmail = currentUser && currentUser.email ? currentUser.email : 'No email provided';
            
            const chatData = {
              userName: userName,
              userEmail: userEmail,
              startTime: new Date().toISOString(),
              messages: [],
              unreadCount: 0
            };
            
            // Use Firebase to create chat session
            if (window.firebaseChatManager) {
              this.currentChatId = await window.firebaseChatManager.createChatSession(chatData);
              console.log('Chat session created:', this.currentChatId);
              
              // Start listening for messages in this chat
              this.startMessageListener();
            } else {
              console.warn('firebaseChatManager not available, using local storage only');
            }
          } catch (error) {
            console.error('Failed to initialize chat session:', error);
          }
        }
      }
      
      startMessageListener() {
        if (this.currentChatId) {
          window.firebaseChatManager.listenForMessages(this.currentChatId, (message) => {
            // Only display messages that aren't from the current user
            const sharedAuth = window.sharedAuth;
            const currentUser = sharedAuth ? sharedAuth.getCurrentUser() : null;
            const isCurrentUser = message.userId === (currentUser ? currentUser.username : 'Anonymous User');
            
            if (!isCurrentUser) {
              this.displayMessage(message.content, message.type, message.timestamp);
            }
          });
        }
      }
      
      saveChatSession(chatSession) {
        try {
          const existingChats = this.getStoredChats();
          const chatIndex = existingChats.findIndex(chat => chat.id === chatSession.id);
          
          if (chatIndex > -1) {
            existingChats[chatIndex] = chatSession;
          } else {
            existingChats.push(chatSession);
          }
          
          // Keep only last 50 chats
          if (existingChats.length > 50) {
            existingChats.splice(0, existingChats.length - 50);
          }
          
          localStorage.setItem('custompc_chat_sessions', JSON.stringify(existingChats));
        } catch (error) {
          console.error('Failed to save chat session:', error);
        }
      }
      
      getStoredChats() {
        try {
          const stored = localStorage.getItem('custompc_chat_sessions');
          return stored ? JSON.parse(stored) : [];
        } catch (error) {
          console.error('Failed to retrieve stored chats:', error);
          return [];
        }
      }
      
      async loadActiveChats() {
        try {
          const activeChats = await window.firebaseChatManager.getActiveChats();
          this.displayChats(activeChats);
        } catch (error) {
          console.error('Failed to load active chats:', error);
          // Fallback to local storage
          const chats = this.getStoredChats();
          const activeChats = chats.filter(chat => {
            const lastActivity = new Date(chat.lastActivity);
            const now = new Date();
            const hoursSinceActivity = (now - lastActivity) / (1000 * 60 * 60);
            return hoursSinceActivity < 24;
          });
          this.displayChats(activeChats);
        }
      }
      
      displayChats(chats) {
        const chatList = document.getElementById('chat-list');
        const emptyChats = document.getElementById('empty-chats');
        
        if (!chatList) return;
        
        if (chats.length === 0) {
          emptyChats.style.display = 'block';
          return;
        }
        
        emptyChats.style.display = 'none';
        
        // Clear existing chats except empty state
        const existingChats = chatList.querySelectorAll('.chat-item');
        existingChats.forEach(chat => chat.remove());
        
        chats.forEach(chat => {
          const chatElement = this.createChatElement(chat);
          chatList.appendChild(chatElement);
        });
      }
      
      createChatElement(chat) {
        const chatElement = document.createElement('div');
        chatElement.className = 'chat-item';
        chatElement.dataset.chatId = chat.id;
        
        if (chat.unreadCount > 0) {
          chatElement.classList.add('unread');
        }
        
        if (chat.id === this.currentChatId) {
          chatElement.classList.add('active');
        }
        
        const lastMessage = chat.messages && chat.messages.length > 0 ? 
          chat.messages[chat.messages.length - 1] : null;
        
        const preview = lastMessage ? 
          (lastMessage.content.length > 30 ? lastMessage.content.substring(0, 30) + '...' : lastMessage.content) :
          'No messages yet';
        
        const timeAgo = this.formatTimeAgo(new Date(chat.lastActivity));
        const initials = chat.userName.substring(0, 2).toUpperCase();
        
        chatElement.innerHTML = `
          <div class="chat-avatar">${initials}</div>
          <div class="chat-info">
            <div class="chat-name">${chat.userName}</div>
            <div class="chat-preview">${preview}</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">${timeAgo}</div>
            ${chat.unreadCount > 0 ? `<div class="unread-badge">${chat.unreadCount}</div>` : ''}
          </div>
        `;
        
        chatElement.addEventListener('click', () => {
          this.openChat(chat.id);
        });
        
        return chatElement;
      }
      
      formatTimeAgo(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'now';
        if (minutes < 60) return `${minutes}m`;
        if (hours < 24) return `${hours}h`;
        return `${days}d`;
      }
      
      openChat(chatId) {
        this.currentChatId = chatId;
        
        // Update active chat styling
        const chatItems = document.querySelectorAll('.chat-item');
        chatItems.forEach(item => {
          item.classList.remove('active');
          if (item.dataset.chatId === chatId) {
            item.classList.add('active');
            item.classList.remove('unread');
          }
        });
        
        // Load chat messages
        this.loadChatMessages(chatId);
        
        // Mark as read
        this.markChatAsRead(chatId);
      }
      
      async loadChatMessages(chatId) {
        try {
          const messages = await window.firebaseChatManager.getChatMessages(chatId);
          
          // Get chat info for contact display
          const activeChats = await window.firebaseChatManager.getActiveChats();
          const chat = activeChats.find(c => c.id === chatId);
          
          if (chat) {
            // Update contact info
            const contactName = document.getElementById('contact-name');
            const contactAvatar = document.getElementById('contact-avatar');
            
            if (contactName) {
              contactName.textContent = `Chat with ${chat.userName}`;
            }
            
            if (contactAvatar) {
              contactAvatar.textContent = chat.userName.substring(0, 2).toUpperCase();
            }
          }
          
          // Clear and load messages
          const chatContainer = document.getElementById('messaging-chat');
          if (chatContainer) {
            chatContainer.innerHTML = '';
            
            if (messages && messages.length > 0) {
              messages.forEach(message => {
                this.displayMessage(message.content, message.type, message.timestamp);
              });
            } else {
              this.displayMessage('Chat session started. Waiting for user message...', 'system', false);
            }
          }
          
          // Start listening for new messages in this chat
          window.firebaseChatManager.listenForMessages(chatId, (message) => {
            this.displayMessage(message.content, message.type, message.timestamp);
          });
          
        } catch (error) {
          console.error('Failed to load chat messages:', error);
          // Fallback to localStorage method
          const chats = this.getStoredChats();
          const chat = chats.find(c => c.id === chatId);
          
          if (chat) {
            const contactName = document.getElementById('contact-name');
            const contactAvatar = document.getElementById('contact-avatar');
            
            if (contactName) {
              contactName.textContent = `Chat with ${chat.userName}`;
            }
            
            if (contactAvatar) {
              contactAvatar.textContent = chat.userName.substring(0, 2).toUpperCase();
            }
            
            const chatContainer = document.getElementById('messaging-chat');
            if (chatContainer) {
              chatContainer.innerHTML = '';
              
              if (chat.messages && chat.messages.length > 0) {
                chat.messages.forEach(message => {
                  this.displayMessage(message.content, message.type, message.timestamp);
                });
              } else {
                this.displayMessage('Chat session started. Waiting for user message...', 'system', false);
              }
            }
          }
        }
      }
      
      displayMessage(content, type, timestamp) {
        const chat = document.getElementById('messaging-chat');
        if (!chat) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        const time = timestamp ? `<div class="message-time">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>` : '';
        
        messageDiv.innerHTML = `
          <div class="message-content">${content}${time}</div>
        `;
        
        chat.appendChild(messageDiv);
        chat.scrollTop = chat.scrollHeight;
      }
      
      markChatAsRead(chatId) {
        const chats = this.getStoredChats();
        const chat = chats.find(c => c.id === chatId);
        
        if (chat) {
          chat.unreadCount = 0;
          this.saveChatSession(chat);
        }
      }
      
      startChatPolling() {
        if (this.isAdmin) {
          // Listen for new chats in real-time
          window.firebaseChatManager.listenForNewChats((chat) => {
            this.loadActiveChats(); // Refresh the chat list when new chats arrive
          });
          
          // Also poll every 10 seconds as backup
          setInterval(() => {
            this.loadActiveChats();
          }, 10000);
        }
      }
      
      showTypingIndicator() {
        if (this.isTyping) return;
        
        const chat = document.getElementById('messaging-chat');
        if (!chat) return;
        
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
          Admin is typing
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        `;
        
        chat.appendChild(typingDiv);
        chat.scrollTop = chat.scrollHeight;
        this.isTyping = true;
      }
      
      hideTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
          typingIndicator.remove();
          this.isTyping = false;
        }
      }
    }
    
    // Global functions
    async function sendMessage() {
      console.log('üöÄ sendMessage called');
      
      const input = document.getElementById('messaging-input');
      const chat = document.getElementById('messaging-chat');
      const sendBtn = document.getElementById('send-btn');
      
      if (!input || !chat) {
        console.error('‚ùå Required elements not found');
        alert('Chat system not ready. Please refresh the page.');
        return;
      }
      
      const message = input.value.trim();
      if (!message) {
        console.log('‚ùå Empty message');
        return;
      }
      
      console.log('üìù Sending message:', message);
      
      // Get current user info
      const currentUser = window.sharedAuth ? window.sharedAuth.getCurrentUser() : null;
      const username = currentUser && currentUser.username ? currentUser.username : 'Anonymous User';
      const userEmail = currentUser && currentUser.email ? currentUser.email : 'No email provided';
      
      // Disable send button
      if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span>Sending...</span><span class="send-icon">‚è≥</span>';
      }
      
      // Clear input
      input.value = '';
      input.style.height = 'auto';
      
      // Add user message to chat immediately
      addMessageToChat(message, 'user', username);
      
      // Save to history
      saveToHistory(message, 'user', username);
      
      // Save message to Firebase for admin dashboard
      let messageSavedToFirebase = false;
      if (window.firebaseChatManager && window.firebaseChatManager.isInitialized) {
        try {
          const messageData = {
            text: message,
            username: username,
            email: userEmail,
            type: 'user',
            timestamp: Date.now()
          };
          
          await window.firebaseChatManager.database.ref('globalChat').push(messageData);
          messageSavedToFirebase = true;
          console.log('‚úÖ Message sent to Firebase (admin will see it in admin-chats.html)');
        } catch (error) {
          console.error('Failed to save message to Firebase:', error);
        }
      } else {
        console.log('‚ö†Ô∏è Firebase not available, message will only be sent via email');
      }
      
      // Send message via Formspree (email notification) - non-blocking
      // This is just for email notifications, Firebase handles the actual messaging
      (async () => {
        try {
          const formData = new FormData();
          formData.append('name', username);
          formData.append('email', userEmail);
          formData.append('message', message);
          formData.append('source', 'Live Messaging System');
          formData.append('timestamp', new Date().toLocaleString());
          formData.append('_subject', `New live chat message from ${username}`);
          
          const response = await fetch('https://formspree.io/f/xrblokly', {
            method: 'POST',
            body: formData,
            headers: {
              'Accept': 'application/json'
            }
          });
          
          if (response.ok) {
            console.log('‚úÖ Message notification sent via Formspree');
          } else {
            console.warn('‚ö†Ô∏è Formspree notification failed (non-critical):', response.status);
          }
          
        } catch (error) {
          console.warn('‚ö†Ô∏è Formspree notification failed (non-critical):', error);
        }
      })();
      
      // Show success message
      if (messageSavedToFirebase) {
        setTimeout(() => {
          addMessageToChat(`‚úÖ Message sent successfully! Our team will respond shortly.`, 'system', 'System');
        }, 500);
      } else {
        // Fallback if Firebase not available
        setTimeout(() => {
          addMessageToChat(`‚úÖ Message sent! We'll respond to ${userEmail} shortly.`, 'system', 'System');
        }, 500);
      }
      
      // Re-enable send button
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<span>Send</span><span class="send-icon">üì§</span>';
      }
      
      // Focus back to input
      input.focus();
    }
    
    // Helper function to add messages to chat
    function addMessageToChat(message, type, username) {
      const chat = document.getElementById('messaging-chat');
      if (!chat) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const userLabel = type !== 'user' && username !== 'System' ? `<strong>${username}:</strong> ` : '';
      
      messageDiv.innerHTML = `
        <div class="message-content">
          ${userLabel}${message}
          <div class="message-time">${time}</div>
        </div>
      `;
      
      chat.appendChild(messageDiv);
      chat.scrollTop = chat.scrollHeight;
      
      // Add smooth animation
      messageDiv.style.opacity = '0';
      messageDiv.style.transform = 'translateY(20px)';
      setTimeout(() => {
        messageDiv.style.transition = 'all 0.3s ease';
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateY(0)';
      }, 10);
    }
    
    // Test function to debug messaging
    function testMessage() {
      console.log('üß™ Test message function called');
      
      const chat = document.getElementById('messaging-chat');
      if (!chat) {
        alert('‚ùå Chat container not found!');
        return;
      }
      
      // Add test message
      const testDiv = document.createElement('div');
      testDiv.className = 'message user';
      testDiv.innerHTML = `
        <div class="message-content">
          üß™ Test message - ${new Date().toLocaleTimeString()}
          <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
      `;
      chat.appendChild(testDiv);
      chat.scrollTop = chat.scrollHeight;
      
      console.log('‚úÖ Test message added');
      
      // Add test response
      setTimeout(() => {
        const responseDiv = document.createElement('div');
        responseDiv.className = 'message system';
        responseDiv.innerHTML = `
          <div class="message-content">
            ‚úÖ Test successful! The messaging system is working.
            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
          </div>
        `;
        chat.appendChild(responseDiv);
        chat.scrollTop = chat.scrollHeight;
        
        console.log('‚úÖ Test response added');
      }, 1000);
    }
    
    // Admin functions
    function refreshChats() {
      console.log('üîÑ Refreshing chats...');
      
      // Show loading state
      const refreshBtn = document.querySelector('button[onclick="refreshChats()"]');
      if (refreshBtn) {
        const originalText = refreshBtn.textContent;
        refreshBtn.textContent = 'üîÑ Refreshing...';
        refreshBtn.disabled = true;
        
        // Reset button after refresh
        setTimeout(() => {
          refreshBtn.textContent = originalText;
          refreshBtn.disabled = false;
        }, 1000);
      }
      
      try {
        if (window.liveMessaging && window.liveMessaging.isAdmin) {
          // Refresh active chats
          window.liveMessaging.loadActiveChats();
          
          // Also refresh Firebase listeners
          if (window.firebaseChatManager) {
            window.firebaseChatManager.refreshListeners();
          }
          
          // Show success message
          showStatusMessage('‚úÖ Chats refreshed successfully', 'success');
          console.log('‚úÖ Chats refreshed successfully');
          
        } else if (window.liveMessaging && !window.liveMessaging.isAdmin) {
          // For regular users, refresh their current chat
          if (window.liveMessaging.currentChatId) {
            window.liveMessaging.loadChatMessages(window.liveMessaging.currentChatId);
            showStatusMessage('‚úÖ Chat refreshed', 'success');
          } else {
            showStatusMessage('‚ÑπÔ∏è No active chat to refresh', 'info');
          }
          
        } else {
          showStatusMessage('‚ùå Messaging system not initialized', 'error');
          console.error('‚ùå Messaging system not available');
        }
        
      } catch (error) {
        console.error('‚ùå Error refreshing chats:', error);
        showStatusMessage('‚ùå Failed to refresh chats', 'error');
      }
    }
    
    // Helper function to show status messages
    function showStatusMessage(message, type = 'info') {
      // Remove existing status messages
      const existingMessages = document.querySelectorAll('.status-message');
      existingMessages.forEach(msg => msg.remove());
      
      // Create new status message
      const statusDiv = document.createElement('div');
      statusDiv.className = `status-message status-${type}`;
      statusDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
      `;
      
      // Set background color based on type
      switch (type) {
        case 'success':
          statusDiv.style.background = '#4caf50';
          break;
        case 'error':
          statusDiv.style.background = '#f44336';
          break;
        case 'warning':
          statusDiv.style.background = '#ff9800';
          break;
        default:
          statusDiv.style.background = '#2196f3';
      }
      
      statusDiv.textContent = message;
      document.body.appendChild(statusDiv);
      
      // Auto-remove after 3 seconds
      setTimeout(() => {
        if (statusDiv.parentNode) {
          statusDiv.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => statusDiv.remove(), 300);
        }
      }, 3000);
    }
    
    function markAllAsRead() {
      if (window.liveMessaging && window.liveMessaging.isAdmin) {
        const chats = window.liveMessaging.getStoredChats();
        chats.forEach(chat => {
          chat.unreadCount = 0;
          window.liveMessaging.saveChatSession(chat);
        });
        window.liveMessaging.loadActiveChats();
      }
    }
    
    function startQuickChat(type) {
      const templates = {
        support: "Hi! I need technical support with my PC. Here's what's happening: [Please describe your issue]",
        quote: "Hi! I'd like to get a quote for a custom PC build. My requirements are: [Please describe what you need]",
        general: "Hi! I have a question about: [Please describe your question]"
      };
      
      const input = document.getElementById('messaging-input');
      if (input && templates[type]) {
        input.value = templates[type];
        input.focus();
        
        // Position cursor at the placeholder
        const placeholderStart = input.value.indexOf('[');
        if (placeholderStart !== -1) {
          input.setSelectionRange(placeholderStart, input.value.indexOf(']') + 1);
        }
        
        // Auto-resize
        if (window.liveMessaging) {
          window.liveMessaging.autoResizeTextarea();
        }
      }
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(event) {
      // Ctrl+R or F5 for refresh (prevent default browser refresh and use our refresh)
      if ((event.ctrlKey && event.key === 'r') || event.key === 'F5') {
        event.preventDefault();
        refreshChats();
        return false;
      }
      
      // Ctrl+Shift+R for force refresh
      if (event.ctrlKey && event.shiftKey && event.key === 'R') {
        event.preventDefault();
        location.reload();
        return false;
      }
    });

    // Get current username
    function getCurrentUsername() {
      const currentUser = window.sharedAuth ? window.sharedAuth.getCurrentUser() : null;
      return currentUser && currentUser.username ? currentUser.username : 'Anonymous User';
    }
    
    // Load chat history from localStorage
    function loadChatHistory() {
      try {
        const username = getCurrentUsername();
        const history = JSON.parse(localStorage.getItem('chat-history-' + username) || '[]');
        console.log('üìú Loading', history.length, 'messages from history for', username);
        
        history.forEach(item => {
          addMessageToChat(item.message, item.type, item.username || 'User');
        });
      } catch (error) {
        console.error('Failed to load chat history:', error);
      }
    }
    
    // Save message to chat history
    function saveToHistory(message, type, username) {
      try {
        const currentUsername = getCurrentUsername();
        let history = JSON.parse(localStorage.getItem('chat-history-' + currentUsername) || '[]');
        
        history.push({
          message: message,
          type: type,
          username: username,
          timestamp: Date.now()
        });
        
        // Keep only last 100 messages
        if (history.length > 100) {
          history = history.slice(-100);
        }
        
        localStorage.setItem('chat-history-' + currentUsername, JSON.stringify(history));
        console.log('üíæ Message saved to history');
      } catch (error) {
        console.error('Failed to save to history:', error);
      }
    }
    
    // Listen for admin responses from Firebase
    function listenForAdminResponses() {
      if (!window.firebaseChatManager || !window.firebaseChatManager.isInitialized) {
        console.log('Firebase not available for listening');
        return;
      }
      
      const username = getCurrentUsername();
      
      // Listen for messages addressed to this user
      const messagesRef = window.firebaseChatManager.database.ref('globalChat');
      
      messagesRef.orderByChild('username').equalTo(username).on('child_added', (snapshot) => {
        const message = snapshot.val();
        
        // Only show admin messages (not our own messages)
        if (message && message.type === 'admin') {
          console.log('üì® Received admin response:', message.text);
          addMessageToChat(message.text, 'admin', 'Admin');
          saveToHistory(message.text, 'admin', 'Admin');
        }
      });
      
      console.log('üëÇ Listening for admin responses for user:', username);
    }

    // Initialize Firebase Chat Manager
    // Note: FirebaseChatManager is already initialized in config/firebase-config.js
    window.addEventListener('load', function() {
      console.log('üöÄ Page loaded, checking Firebase connection');
      
      // Load chat history first
      loadChatHistory();
      
      // Wait for Firebase to initialize (config/firebase-config.js creates the global instance)
      const checkFirebase = () => {
        if (window.firebaseChatManager) {
          if (window.firebaseChatManager.isInitialized) {
            console.log('‚úÖ Firebase ready for messaging');
            addMessageToChat('üî• Connected! Send a message and our team will respond.', 'system', 'System');
            
            // Start listening for admin responses
            listenForAdminResponses();
          } else {
            console.log('‚ö†Ô∏è Firebase not available, using local mode');
            addMessageToChat('üí¨ Chat ready! Messages will be sent via email.', 'system', 'System');
          }
        } else if (typeof firebase !== 'undefined') {
          // Firebase SDK is loaded but manager not initialized yet, wait a bit longer
          setTimeout(checkFirebase, 500);
        } else {
          console.log('‚ö†Ô∏è Firebase SDK not loaded');
          addMessageToChat('üí¨ Chat ready! Messages will be sent via email.', 'system', 'System');
        }
      };
      
      // Check after a short delay to allow Firebase to initialize
      setTimeout(checkFirebase, 1000);
    });

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM loaded, initializing chat interface');
      
      // Check if chat container exists
      const chatContainer = document.getElementById('messaging-chat');
      console.log('Chat container found:', chatContainer);
      
      if (!chatContainer) {
        console.error('‚ùå Chat container not found in DOM!');
        return;
      }
      
      // Initialize basic chat interface
      addMessageToChat('Welcome to CustomPC.tech live support! üí¨', 'system', 'System');
      
      // Initialize complex messaging system if needed
      if (typeof LiveMessagingPage !== 'undefined') {
        window.liveMessaging = new LiveMessagingPage();
        console.log('‚úÖ LiveMessagingPage created:', window.liveMessaging);
      }
      
      // Ensure chat session is created for non-admin users
      // This helps ensure messages from Tawk.to can be saved
      setTimeout(() => {
        if (window.liveMessaging && !window.liveMessaging.isAdmin && !window.liveMessaging.currentChatId) {
          console.log('Delayed chat session initialization');
          window.liveMessaging.initializeChatSession();
        }
      }, 1000);
    });
  </script>
</body>
</html>